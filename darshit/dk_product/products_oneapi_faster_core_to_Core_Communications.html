<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faster Core-to-Core Communications</title>

    <link rel="stylesheet" href="/css/dk_developer_edge_iot_&_5G_social_distancing_for_retail_settings.css">

    <!-- header footer -->
    <link rel="stylesheet" href='/css/yatri.css'>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" rel="stylesheet">
</head>

<style>
    .dk_oneapi_deco{
        color: #0068b5;
        font-weight: bold;
    }
    .dk_oneapi_deco:hover{
        text-decoration: underline;
    }
    @media (max-width: 767px){
    .dk_designed_oneapi{
        flex-wrap: wrap-reverse !important;
    }
    .dk_designed_oneapi img{
        margin-bottom: 2rem;
        }  
    .dk_types_of_information img{
        width: 100% !important;
    }     
    }
    .dk_overview_api{
        word-wrap: break-word;
        background-color: #e6e6e6;
        padding: 20px;
        border-left: 3px solid #fdb813;
    }
    .dk_overview_api p{
        font-weight: bold;
    }
    .dk_overview_api_sub{
        color: blue;
        text-decoration: underline !important;
        font-weight: 700;
    }
    .dk_overview_api_sub:hover{
        color: blue;
    }
    .dk_overview_api_sub2{
        color: blue;
        text-decoration: underline !important;
        font-weight: 400;
    }
    .dk_overview_api_sub2:hover{
        color: blue;
    }
</style>

<body>

    <!-- header -->
    <div id="navbar"></div>

    <!-- Social Distancing for Retail Settings -->
    <section>
        <div class="mv_intel_amx_bg_color">
            <div class="container">
                <div class="row mv_intel_amx_content">
                    <div class="col-md-12 col-sm-12 mv_intel_amx_item">
                        <div class="mv_intel_amx">
                            <h1 style="font-weight: 300; font-size: 2.25rem;">Faster Core-to-Core Communications</h1>
                            <p>October 25, 2024</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="container py-5">
        <div class="row">
            <div class="d-flex justify-content-end col-xl-10 py-3 d-md-none">
                <i class="fa-solid fa-print fs-4 px-2 " style="color:#0068B5"></i>
                <i class="fa-regular fa-envelope fs-4 px-2" style="color:#0068B5"></i>
            </div>
            <div class="col-lg-3 col-md-4">
                <!-- nav -->
                <div class="VK_sticky_side_bar VK_side_bar_postion_stickey">
                    <div>
                        <div class="VK_sidebar_dropdown">
                            <p class="m-0">
                                <a href="#dk_problem_msg_latency" class="text-decoration-none VK_a">
                                    The Problem with Message Latency
                                </a>
                            </p>
                            <p class="m-0">
                                <a href="#dk_coherent_fundamentals" class="text-decoration-none VK_a">
                                    Coherent Memory Fundamentals
                                </a>
                            </p>
                            <p class="m-0">
                                <a href="#dk_coherent_memory" class="text-decoration-none VK_a">
                                    Coherent Memory Multicore Complexity
                                </a>
                            </p>
                            <details>
                                <summary>
                                    <a href="#dk_core_to_core_latency" class="text-decoration-none VK_a">
                                        Core to Core Latency
                                    </a>
                                </summary>
                                <ul class="list-unstyled ps-3 mb-0">
                                    <li>
                                        <a href="#dk_latency_test" class="text-decoration-none VK_a my-1">
                                            Latency Test Code Example
                                        </a>
                                    </li>
                                </ul>
                            </details>
                            <details>
                                <summary>
                                    <a href="#dk_core_to_core_band" class="text-decoration-none VK_a">
                                        Core-to-Core Bandwidth
                                    </a>
                                </summary>
                                <ul class="list-unstyled ps-3 mb-0">
                                    <li>
                                        <a href="#dk_core_to_core_msg" class="text-decoration-none VK_a my-1">
                                            Core-to-Core Messaging Takeaway
                                        </a>
                                    </li>
                                </ul>
                            </details>
                            <details>
                                <summary>
                                    <a href="#dk_ring_buffer" class="text-decoration-none VK_a">
                                        The Ring Buffer
                                    </a>
                                </summary>
                                <ul class="list-unstyled ps-3 mb-0">
                                    <li>
                                        <a href="#dk_configuration" class="text-decoration-none VK_a my-1">
                                            Configuration Details for Tests in this Article
                                        </a>
                                    </li>
                                </ul>
                                <ul class="list-unstyled ps-3 mb-0">
                                    <li>
                                        <a href="#dk_code_ex_classic" class="text-decoration-none VK_a my-1">
                                            Code Example: Classic Ring Buffer
                                            <ul style="list-style-type: none;">
                                                <a href="#message_noti"><li>Message Notification</li></a>
                                                <a href="#flow_control"><li>Flow Control</li></a>
                                            </ul>
                                        </a>
                                    </li>
                                </ul>
                                <ul class="list-unstyled ps-3 mb-0">
                                    <li>
                                        <a href="#dk_code_ex_ring" class="text-decoration-none VK_a my-1">
                                            Code Example: New Ring Buffer
                                        </a>
                                    </li>
                                </ul>
                                <ul class="list-unstyled ps-3 mb-0">
                                    <li>
                                        <a href="#dk_cache_line" class="text-decoration-none VK_a my-1">
                                            Cache Line Demote
                                        </a>
                                    </li>
                                </ul>
                            </details>
                            <p class="m-0">
                                <a href="#dk_conclusion" class="text-decoration-none VK_a">
                                    Conclusion
                                </a>
                            </p>
                            <p class="m-0">
                                <a href="#dk_download_tool" class="text-decoration-none VK_a">
                                    Download the Toolkits
                                </a>
                            </p>
                            <p class="m-0">
                                <a href="#dk_references_faster" class="text-decoration-none VK_a">
                                    References
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
                <!-- thinkcode -->
                <div class="dk_things_code_main">
                    <div class="dk_things_code">
                        <h2 class="text-left headline-font-one-bold mb-4">Get the Latest on All Things CODE</h2>
                        <a class="dk_button" href="">Sign Up</a>
                        <p class="mb-0">&nbsp;</p>
                    </div> 
                </div>
                <p id="" class=""><p><a class="b_special_a2" href=""><b>Bryan Morgan</b></a>, Middleware Software Architect</p>
                <p><b>Ted Painter</b>, Middleware Software Architect</p>
                <p>Intel Corporation</p>
                <p>&nbsp;</p>
                <p><a class="b_special_a2" href=""><b>Lawrence Stewart</b></a>, CTO</p>
                <p>Serissa Research&nbsp;</p>
                </p>
            </div>
            <div class="col-lg-9 col-md-8">
                <div class="d-md-flex justify-content-end col-xl-10 py-3 d-none">
                    <i class="fa-solid fa-print fs-4 px-2 " style="color:#0068B5"></i>
                    <i class="fa-regular fa-envelope fs-4 px-2" style="color:#0068B5"></i>
                </div>
                <div class="col-xl-10 VK_all_sections">
                    <section id="dk_random_number">
                        <p class="mb-0">&nbsp;</p>
                        <p class="mb-0">&nbsp;</p>
                        <p class="mb-0">&nbsp;</p>
                    </section>

                    <section id="dk_problem_msg_latency">
                        <h3 style="font-weight: 300;">The Problem with Message Latency</h3>
                        <p>While memory bandwidth and thus throughput has improved tremendously over the years, end-to-end latency for short messages hasn’t changed much over the last 25 years. These short messages are, however, vital for multicore communication and compute for data intensive workloads in distributed systems. Not taking their importance into account can lead to serious performance degradation.</p>
                        <p>In this article, we will discuss using a mofified ring buffer to optimize short message latency and throughput. By carefully refining the design of the classic ring buffer, we can&nbsp;boost througput to 450 million 64-byte messages per second from multiple senders to a single 4<sup>th</sup> generation Intel® Xeon® Scalable Processor core (8 requestors and a single server thread).</p>
                        <p>This outlines the beginnings of our multi-front efforts to accelerate multicore coherent communication and distributed data management.&nbsp;</p>
                    </section>

                    <p class="">&nbsp;</p>

                    <section id="dk_coherent_fundamentals">
                     <h3 style="font-weight: 300">Coherent Memory Fundamentals</h3>
                     <p>Most programmers are aware of modern multicore processors’ basic coherent memory design: If one core writes a memory location and then another core reads it, the second core will get the new value. Of course, there are many additional subtleties to this, and different architectures have different models for “memory ordering,” but the general idea remains the same.</p>
                     <p>The workflow timing of sending individual messages is straightforward, with the general outline being.</p>

                     <div style="display: flex;">
                        <table align="center" border="1" cellpadding="1" cellspacing="1" style="width:700px" class="dk_new_options_table">
                            <thead>
                                <tr>
                                    <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">Core 1</td>
                                    <td style="background: #e2e2e2; text-align: left;">Core 2</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;">Write Message Buffer</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;">Atomic Write Flag with “release” semantics</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;"></td>
                                    <td style="font-weight: 300 !important;">Atomic Read Flag with “acquire” semantics</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;"></td>
                                    <td style="font-weight: 300 !important;">Read Message Buffer</td>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <p>&nbsp;</p>

                    <p>The flag write with release semantics does whatever is necessary on the platform to ensure that the message buffer writes become visible to other threads no later than the write to the flag. The flag read with acquire semantics does whatever is necessary on the platform to ensure that the reads to the message buffer happen no earlier than the read of the flag.</p>

                    <p>This is all fine, but what happens when you want to send many messages?</p>

                    <p>The obvious thing to do is for the receiver to acknowledge the message by clearing the flag and for the sender to check the flag before writing a new message, but this turns out to be quite slow and thus inefficient.</p>
                    
                    </section>
                     <p class="mb-0">&nbsp;</p>

                     <section id="dk_coherent_memory"> 
                        <h3 style="font-weight: 300;">Coherent Memory Multicore Complexity</h3>
                        <p>So, let's examine the concept of coherency more closely to see if we can find a more compelling approach.</p>
                        <p>At the top of this post, we mentioned that modern multicore processors have coherent memory.&nbsp; In the early years of multiprocessors, this sort of thing was done by having each CPU read and write main memory on every access.&nbsp; There were no caches and no memory ordering issues.&nbsp; Cores are so fast these days, and main memory is so relatively slow that performance would be quite disappointing without caches.&nbsp; When one thread on one core is reading and writing memory, the caches intercept most accesses and quickly return results. However, it gets quite complicated when multiple cores want to use the same memory locations, either accidentally or on purpose.</p>
                        <p>Many designs use a coherence protocol called MESI (Modified, Exclusive, Shared, and Invalid), reflecting the accessibility and validity status of data. When multiple cores read a location, it can be in both caches in a “shared” state. When either core wishes to write, the other copy must first be invalidated. To address this, most designs use a cache directory type implementation where an on-chip “caching and home agent” keeps track of which cores have copies of each address and in which states.&nbsp;</p>
                        <p>When a core wishes to write, and the state is not exclusive, the core must ask the home agent for permission.&nbsp; If any other caches have copies, the home agent sends them “snoop invalidate” messages. Once those are acknowledged, the home agent sends the requesting cache permission to enter an exclusive state.</p>
                        <p>If a core wishes to read a location and it is invalid, the core must ask the home agent for permission.&nbsp; The home agent can either return the data (from memory or L3 cache) or if some other core has the location in exclusive (or modified) state, the home agent asks the owning agent to move to state shared and return any modified data to the agent so that the agent can deliver it to the requesting core.&nbsp;</p>
                        <p>Some designs use the MOESI (Modified Owned Exclusive Shared Invalid) protocol, which adds a fifth owner state. Owned data is tagged as both modified and shared. This designation allows modified data to be written back to the main memory before sharing it. While the data must still be written back eventually, the write-back may be deferred.</p>
                        <p>In short, it can get complicated, and the added complexity of all this messaging across the chip adds the potential for significant latency and performance degradation.</p>
                     </section>
                     <p class="mb-0">&nbsp;</p>


                    <section id="dk_core_to_core_latency">
                        <h3 style="font-weight: 300;">Core to Core Latency</h3>
                        <p>So, how long does it take for one core to set a flag and another core to notice it? Let us write a test program and find out!</p>
                        <p>Suppose we look, for example, at a two-socket <a class="b_special_a1" href="">Intel® Xeon® CPU Max 9480 Processor</a>-based system (code-named Sapphire Rapids) with 112 cores and 224 threads. Each core in this system has two hyperthreads, which share the core hardware.</p>
                        <p>The code example has two threads, which set themselves to run on specified cores and then bounce a flag back and forth, measuring the number of time stamp counter ticks it takes to complete a given number of handoffs.</p>
                    </section>
                    
                    <section id="dk_core_to_core_latency">
                        <h4>Latency Test Code Example</h4>

                          <!-- code toolbar 3 -->
                     <div class="mv_code_toolbar">
                        <div class="mv_toolbar_item mv_copy_icon">
                            <i class="fa-regular fa-copy"></i>
                        </div>
                        <div class="mv_copy_message text-end hidden">Copied</div>
                        <div class="code-content">
                            <div style="padding-bottom: 0rem !important" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    1
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"><span class="dk_code_blue">void</span>  <span class="dk_code_org">*</span> remote_thread( <span class="dk_code_blue">void</span> <span class="dk_code_org">*</span> arg __attribute__ ( ( unused ) ) )</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    2
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"><span>{</span></p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    3
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set_cpu ( remote_cpu ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    4
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ready <span class="dk_code_org">=</span> <span class="dk_code_blue">1</span> ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    5
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_code_blue">for</span> ( <span class="dk_code_blue">uint64_t</span>  i <span class="dk_code_org">=</span>  1 ; i <span class="dk_code_org"><=</span>  nrequests ; i <span class="dk_code_org">+=</span>  <span class="dk_code_blue">2</span>) {</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    6
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">while</span>  ( data . flag . load (std <span class="dk_code_org">: :</span> memory_order_acquire ) <span class="dk_code_org">!=</span> i );</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    7
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.flag.store ( i <span class="dk_code_org">+</span> <span class="dk_code_blue">1</span> , std <span class="dk_code_org"> : :</span> memory_order_release);</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    8
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    9
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_code_blue">return</span>  ( <span class="dk_code_blue"> NULL
                                        </span>  ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    10
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> }</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    11
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    12
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"><span class="dk_code_blue">unsigned long</span>  send_wait ( ) {</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    13
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_cpu ( main_cpu );</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    14
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">while</span>  ( ready . load ( std <span class="dk_code_org">: :</span>  memory_order_acquire )  <span class="dk_code_org">==</span> <span class="dk_code_blue">0</span> ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    15
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">unsigned long </span>start <span class="dk_code_org">=</span>  rdtsc ( ) ; s</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    16
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_code_blue">for</span> ( <span class="dk_code_blue">uint64_t</span> i =  <span class="dk_code_blue">1</span> ; i <= nrequests ; i += <span class="dk_code_blue">2</span> ) {</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    17
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.flag.store ( i , std <span class="dk_code_org">: :</span> memory_order_release ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    18
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">while</span> ( data.flag.load ( std <span class="dk_code_org">: :</span> memory_order_acquire ) <span class="dk_code_org">!=</span> i <span class="dk_code_org">+</span> <span class="dk_code_blue">1</span> );</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    19
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    20
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">unsigned long </span> stop <span class="dk_code_org">=</span> rdtsc();</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    21
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">return</span> (stop <span class="dk_code_org">-</span> start);</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    22
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p>In our example configuration, the read timestamp counter (RDTSC) ticks at 2 GHz, and the program shows the following data for half-round trip times.</p>

                    <div style="display: flex;">
                        <table align="center" border="1" cellpadding="1" cellspacing="1" style="width:500px" class="dk_new_options_table">
                            <thead>
                                <tr>
                                    <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">Situation</td>
                                    <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">RDTSC Counts</td>
                                    <td style="background: #e2e2e2; text-align: left;">Nanoseconds</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;">Same core (other HT)</td>
                                    <td>33</td>
                                    <td>16.5</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;">Same socke</td>
                                    <td>123</td>
                                    <td>61.5</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;">Other socket</td>
                                    <td style="font-weight: 300 !important;">300</td>
                                    <td>150</td>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <p>&nbsp;</p>
                    <p>&nbsp;</p>
                    <div style="background-color: #e6e6e6; padding: 20px;">
                        <strong>Note:</strong>
                        <p class="mb-0">For a more detailed discussion of the effects resulting in these observations, you can check out <a class="b_special_a1" href="">Jason Rahman’s Core-to-Cory Latency study on SubStack</a> . [1]</p>
                    </div>
                    <p>&nbsp;</p>
                    </section>

                    <section id="dk_core_to_core_band">
                        <h3 style="font-weight: 300 !important;">Core-to-Core Bandwidth</h3>
                        <p>We have established that core-to-core communication latencies can easily become undesirably high, but what about bandwidth?&nbsp;</p>
                        <p>We can measure this, too, by writing a buffer on one core, waiting for the flag, and then reading the buffer on another core and measuring the time.&nbsp; Using the same platform configuration as before and a similar methodology, we find that if one core writes 32K bytes, it takes about 9000 RDTSC counts, or 4.5 microseconds, for another core to read it.&nbsp; That translates to about 7.3 GB/sec.&nbsp;</p>
                        <p>Interestingly, a recent new instruction called CLDEMOTE lets the programmer hint to the hardware that a cache line should be pushed down in the cache hierarchy, perhaps all the way to L3.&nbsp; When done, the second core can read 32K bytes in around 2900 RDTSC counts, or about 22 GB/sec. This number agrees with the observations John McCalpin reported in his presentation “<a href="" style="color:#467886; text-decoration:underline !important">Bandwidth Limits in the Intel® Xeon® CPU Max Series</a>” at the International Supercomputing 2023 IXPUG Workshop. &nbsp;[2]</p>
                        <p>We also know that a processor core can have quite a few outstanding memory operations.&nbsp; For example, in the first case here, reading data that is dirty in a different core’s cache, we can traverse 512 cache lines (32K bytes) in 4.5 microseconds, or about 8.8 nanoseconds each, even though the same socket round trip is 120 nanoseconds. The data flow here is delivered by combining out-of-order execution, multiple outstanding memory references, and aggressive hardware prefetching.</p>
                    </section>

                    <section id="dk_core_to_core_msg">
                        <h4>Core-to-Core Messaging Takeaway</h4>
                        <p>With these measurements, we can establish a “roofline” for core-to-core messages. They inform us of hardware limits to latency and bandwidth and a software goal.</p>
                        <p>The key takeaway from our observations thus far is that a fast core-to-core protocol should avoid memory coherence activity as much as possible.</p>
                        <p>At this point, we let us dig into a popular message queuing mechanism, the ring buffer, to see what additional controls on the core-to-core messaging performance we may have.</p>
                        <p class="mb-0">&nbsp;</p>
                    </section>

                    <section id="dk_ring_buffer">
                        <h4 style="font-weight: 300;">The Ring Buffer</h4>
                        <p>Ring buffer data structures have a long history of being used as bounded queues between producers and consumers. Many closed and open-source libraries, technical papers, and book expositions are available, as are ring buffer data structures.</p>
                        <p>For example, Herlihy’s “<a href="" style="color:#467886; text-decoration:underline !important">The Art of Multiprocessor Programming</a>” [3] devotes a chapter to the subject. Figure 1 shows a classic ring buffer design using shared control variables.</p>
                        <div class="">
                            <img class="w-100" src="/img/darshit_image/read-write-pointe-graph -core-2-core-comms.png" alt="">
                        </div>
                        <p><em><strong>Figure 1.</strong> Classic Ring Buffer Design</em></p>
                    </section>

                    <section id="dk_configuration">
                        <h4>Configuration Details for Tests in this Article</h4>
                        <p><strong>Testing Date: </strong>Performance results are <strong>based on testing by Intel as of October 25, 2024 </strong>and may not reflect all publicly available security updates.</p>
                        <p><strong>Configuration Details and Workload Setup: </strong>1-node, 1x Intel® Xeon® CPU Max 9480 processor on Denali Pass platform with 512 GB (16 slots/ 32GB/ 3200) total DDR5 memory, ucode 0x2c0001d1, HT on, Turbo on, EIST on, SUSE Linux Enterprise Server 15 SP5, 5.14.21-150500.55.80-default, 1x NVMe 1.0TB OS Drive; Intel(R) oneAPI DPC++/C++ Compiler 2024.2.0 (2024.2.0.20240602).</p>
                        <p>Performance results are based on testing as of dates shown in configurations and may not reflect all publicly available updates. See configuration disclosure for details.&nbsp; No product or component can be absolutely secure.</p>
                        <p>Performance varies by use, configuration, and other factors. Learn more at www.Intel.com/PerformanceIndex. Your costs and results may vary.</p>
                    </section>

                    <section id="dk_code_ex_classic">
                        <h4>Code Example: Classic Ring Buffer</h4>
                        <p>Let us look at a C++ class that implements the idea of a ring buffer:</p>
                
            
                         <!-- code toolbar 3 -->
                     <div class="mv_code_toolbar">
                        <div class="mv_toolbar_item mv_copy_icon">
                            <i class="fa-regular fa-copy"></i>
                        </div>
                        <div class="mv_copy_message text-end hidden">Copied</div>
                        <div class="code-content">
                            <div style="padding-bottom: 0rem !important" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    1
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> <span class="dk_code_blue">typedef struct</span> { </p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    2
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_code_blue">uint32_t</span> data [ <span class="dk_code_blue">15</span> ];</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    3
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std <span class="dk_code_org">: :</span> atomic_uint32_t sequence</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    4
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">} message_t ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    5
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    6
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"><span class="dk_code_blue">class</span> alignas ( CACHELINE_SIZE ) Ring {</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    7
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std <span class="dk_code_org">: :</span> atomic_uint32_t shared_write_pointer __attribute__( ( aligned ( CACHELINE_SIZE ) ) );</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    8
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std <span class="dk_code_org">: :</span> atomic_uint32_t shared_read_pointer __attribute__ ( ( aligned ( CACHELINE_SIZE ) ) );</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    9
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">unsigned</span> sender_write_pointer __attribute__( ( aligned ( CACHELINE_SIZE ) ) );</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    10
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">unsigned</span> sender_read_pointer __attribute__( ( aligned ( CACHELINE_SIZE ) ) ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    11
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">unsigned</span> receiver_write_pointer __attribute__( ( aligned ( CACHELINE_SIZE ) ) ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    12
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">unsigned</span> receiver_read_pointer __attribute__ ( ( aligned ( CACHELINE_SIZE ) ) )</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    13
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">unsigned</span> ring_size __attribute__( ( aligned( CACHELINE_SIZE ) ) );</p>

                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    14
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message_t <span class="dk_code_org">*</span>ring __attribute__( ( aligned ( CACHELINE_SIZE ) ) );</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-bottom: 0rem !important; padding-top: 0rem !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    15
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    16
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"><span class="dk_code_blue">public</span> <span class="dk_code_org">:</span></p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    17
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ring ( <span class="dk_code_blue">unsigned</span> size )</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    18
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    19
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ring_size <span class="dk_code_org">=</span> size ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    20
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shared_write_pointer.store ( <span class="dk_code_blue">0</span> ) ;
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    21
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shared_read_pointer.store ( <span class="dk_code_blue">0</span> ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    22
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sender_write_pointer <span class="dk_code_org">=</span> <span class="dk_code_blue">0</span> ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    23
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sender_read_pointer <span class="dk_code_org">=</span> <span class="dk_code_blue">0</span> ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    24
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;receiver_write_pointer <span class="dk_code_org">=</span> <span class="dk_code_blue">0</span> ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    25
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;receiver_read_pointer <span class="dk_code_org">=</span> <span class="dk_code_blue">0</span> ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    26
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ring <span class="dk_code_org">=</span> ( message_t <span class="dk_code_org">*</span> ) aligned_alloc ( CACHELINE_SIZE, ring_size <span class="dk_code_org">*</span> sizeof( message_t ) ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    27
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert ( ring ) ;</p>

                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    28
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">for</span> ( <span class="dk_code_blue">unsigned</span> i <span class="dk_code_org">=</span> <span class="dk_code_blue">0</span> ; i <span class="dk_code_org"><</span> ring_size; i <span class="dk_code_org">+=</span> <span class="dk_code_blue">1</span> ) ring [ i ] .sequence .store ( <span class="dk_code_blue">0</span> <span class="dk_code_org">-</span> ring_size ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-bottom: 0rem !important; padding-top: 0rem !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    29
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    30
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    31
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_org">~</span> Ring()</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    32
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    33
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free ( ring ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    34
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ring <span class="dk_code_org">=</span> <span class="dk_code_blue">NULL</span> ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    35
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    36
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    37
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">void </span> send ( message_t <span class="dk_code_org">&</span>msg )</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    38
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    39
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_code_blue">unsigned</span> wp <span class="dk_code_org">=</span> sender_write_pointer;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    40
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_code_blue">while</span> ( ( wp <span class="dk_code_org">-</span> shared_read_pointer.load ( std <span class="dk_code_org">: :</span> memory_order_acquire ) ) <span class="dk_code_org">>=</span> ( ring_size <span class="dk_code_org">-</span><span class="dk_code_blue">1</span> ) ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    41
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memcpy ( <span class="dk_code_org">&</span>ring [ wp % ring_size]  , <span class="dk_code_org">&</span>msg, <span class="dk_code_blue">sizeof</span> ( message_t ) <span class="dk_code_org">-</span> <span class="dk_code_blue">sizeof</span> ( std <span class="dk_code_org">: :</span> atomic_uint32_t ) );</p>

                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    42
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ring [ wp <span class="dk_code_org">%</span> ring_size ] .sequence.store ( wp , std <span class="dk_code_org">: :</span> memory_order_relaxed ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    43
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wp <span class="dk_code_org">+=</span> <span class="dk_code_blue">1</span> ;</p>

                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    44
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shared_write_pointer.store ( wp, std <span class="dk_code_org">: :</span> memory_order_release ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-bottom: 0rem !important; padding-top: 0rem !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    45
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sender_write_pointer <span class="dk_code_org">=</span> wp ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    46
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    47
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    48
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">int</span> poll ( ) </p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    49
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    50
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"><span class="dk_code_blue"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unsigned</span> rp <span class="dk_code_org">=</span> receiver_read_pointer;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    51
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_code_blue">unsigned</span> wp <span class="dk_code_org">=</span> shared_write_pointer.load ( std <span class="dk_code_org">: :</span> memory_order_acquire ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    52
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_code_blue">if</span> ( rp <span class="dk_code_org">==</span> wp ) <span class="dk_code_blue">return 0</span> ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    53
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; message_t <span class="dk_code_org">*</span>mp <span class="dk_code_org">=</span> <span class="dk_code_org">&</span>ring [ rp <span class="dk_code_org">&</span> ring_size ] ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    54
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; assert ( mp<span class="dk_code_org">-></span> sequence <span class="dk_code_org">==</span> rp ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    55
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rp <span class="dk_code_org">=</span> rp <span class="dk_code_org">+</span> <span class="dk_code_blue">1</span> ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    56
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shared_read_pointer.store(rp, std <span class="dk_code_org">: :</span> memory_order_release);</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    57
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; receiver_read_pointer <span class="dk_code_org">=</span> rp ;</p>

                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    58
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_code_blue">return</span>( <span class="dk_code_blue">1</span> ) ; </p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    59
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    60
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> } ;</p>
                                    </div> 
                                </div>
                            </div>
                        </div>
                    </div>
                    <p>We can take some measurements if we use a test program that starts a receive thread on one core and starts N sending threads on other cores.</p>
                    <p>Each sender of this program has a copy of the ring. The receiver polls all of them in turn until the expected number of messages has been received. In addition, each thread uses the <a href="" style="color:#467886; text-decoration:underline !important">Performance Counter API (PAPI) library</a> to record the number of Data Cache Misses during a run. All runs use 100,000 messages per sending thread.</p>

                        <table align="center" border="1" cellpadding="1" cellspacing="1" style="width:100%" class="dk_new_options_table">
                            <thead>
                                <tr>
                                    <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">Number of senders</td>
                                    <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">RDTSC Cycles Per Message</td>
                                    <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">Receiver misses per message</td>
                                    <td style="background: #e2e2e2; text-align: left;">Sender misses per message</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;">1</td>
                                    <td style="font-weight: 300 !important;">181</td>
                                    <td style="font-weight: 300 !important;">2.3</td>
                                    <td style="font-weight: 300 !important;">1.98</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;">2</td>
                                    <td style="font-weight: 300 !important;">107</td>
                                    <td style="font-weight: 300 !important;">2.4</td>
                                    <td style="font-weight: 300 !important;">2.4</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;">4</td>
                                    <td style="font-weight: 300 !important;">144.8</td>
                                    <td style="font-weight: 300 !important;">2.9</td>
                                    <td style="font-weight: 300 !important;">2.9</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;">8</td>
                                    <td style="font-weight: 300 !important;">117.6</td>
                                    <td style="font-weight: 300 !important;">2.92</td>
                                    <td style="font-weight: 300 !important;">2.92</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;">16</td>
                                    <td style="font-weight: 300 !important;">134.7</td>
                                    <td style="font-weight: 300 !important;">2.87</td>
                                    <td style="font-weight: 300 !important;">2.92</td>
                                </tr>
                            </thead>
                        </table> 
                    <p>&nbsp;</p>
                    <div class="">
                        <img class="w-100" src="/img/darshit_image/cache-misses1.png" alt="">
                    </div>
                    <p>The peak bandwidth here is achieved with two clients and one server thread. We measure about 1.2 gigabytes per second, with a message rate of 18.7 million messages per second. The miss rates (for four client threads or more, are just about 3 misses per message for both sender and receiver.</p>
                    <p>These results make sense because each end of the connection will take a miss on the read pointer, the write pointer, and the message itself.</p>
                    <p>The big problem here is that the shared_read_pointer and the shared_write_pointer, as their names suggest, are used by both sender and receiver, which leads to additional coherence activity that may not be logically necessary.</p>

                    <table align="center" border="1" cellpadding="1" cellspacing="1" style="width:700px" class="dk_new_options_table">
                        <thead>
                            <tr>
                                <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;"></td>
                                <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">Sender Use</td>
                                <td style="background: #e2e2e2; text-align: left;">Receiver Use</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 300 !important;">Write Pointer</td>
                                <td style="font-weight: 300 !important;">Allocate Ring Space</td>
                                <td style="font-weight: 300 !important;">New Message Detection (notification)</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 300 !important;">Read Pointer</td>
                                <td style="font-weight: 300 !important;">Flow Control (ring full detection)</td>
                                <td style="font-weight: 300 !important;">Flow Control</td>
                            </tr>
                        </thead>
                    </table>
                    </section>
                    <p class="mb-0">&nbsp;</p>

                    <section id="message_noti">
                        <h4>Message Notification</h4>
                        <p>Briefly put, the receiver needs to know when a new message is available. With the classic ring buffer, when the write pointer is not equal to the read pointer, at least one message is available. The receiver must touch three memory locations to receive a message: the write pointer, the read pointer, and the message itself.</p>
                        <p>But suppose the message-ready flag is in the message itself?&nbsp; Then, the receiver can both test for the presence of a new message and read it in one access!&nbsp; In a ring buffer, the receiver always knows where the next message will arrive but not when. As long as we can guarantee that at least one bit of a new message differs from the previous message to occupy the same ring buffer slot, the receiver can always tell when a new message is present.&nbsp;</p>
                        <p>We could dedicate a bit of a ring slot as a flag. The sender can set it, and the receiver can clear it. But we can do even better by having the sender toggle the flag bit between one use of the buffer and the subsequent use. That way, the receiver never has to write into the buffer, which simplifies the buffer's coherence.</p>
                    </section>

                    <section id="flow_control">
                        <h4>Flow Control</h4>
                        <p>The sender needs to know if there is space in the ring before it can send a new message. In the classic ring buffer, the ring is full when the read pointer is one location ahead of the write pointer. Otherwise, there is at least one open slot.</p>
                        <p>The sender must touch three memory locations to send a message: the write pointer, the read pointer, and the message itself.&nbsp; If we don’t insist, though, that, indeed, every slot in the ring be usable, flow control can be done in a lazier way, which requires much less interaction between sender and receiver.&nbsp;</p>
                        <p>In particular, the receiver can keep a second copy of its own read pointer, specifically for use by the sender for flow control, but update it only occasionally, every 10<sup>th</sup> or 100<sup>th</sup> message.&nbsp; This way, the coherence traffic needed for flow control can be greatly reduced.</p>
                        <p class="mb-0">If we combine these two ideas:</p>
                        <ul>
                            <li>putting the message notification in the message itself</li>
                            <li>making flow control to be “lazy”</li>
                        </ul>
                        <p>then the sender can send a message with just a fraction over one cache miss per message: the message itself and an occasional miss while checking the lazy flow control value.&nbsp;</p>
                        <p>Here is a reimplementation of the ring buffer object that incorporates these ideas.</p>
                    </section>

                    <section id="dk_code_ex_ring">
                        <h4>Code Example: New Ring Buffer</h4>
                           <!-- code toolbar 3 -->
                     <div class="mv_code_toolbar">
                        <div class="mv_toolbar_item mv_copy_icon">
                            <i class="fa-regular fa-copy"></i>
                        </div>
                        <div class="mv_copy_message text-end hidden">Copied</div>
                        <div class="code-content">
                            <div style="padding-bottom: 0rem !important" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    1
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> <span class="dk_code_blue">typedef struct</span> { </p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    2
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_code_blue">uint32_t</span> data [ <span class="dk_code_blue">15</span> ];</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    3
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std <span class="dk_code_org">: :</span> atomic_uint32_t sequence ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    4
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">} message_t ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    5
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    6
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"><span class="dk_code_blue">class</span> alignas ( CACHELINE_SIZE ) Ring {</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    7
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std <span class="dk_code_org">: :</span> atomic_uint32_t shared_write_pointer __attribute__( ( aligned ( CACHELINE_SIZE ) ) );</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    8
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std <span class="dk_code_org">: :</span> atomic_uint32_t shared_read_pointer __attribute__ ( ( aligned ( CACHELINE_SIZE ) ) );</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc" class="pe-3">
                                    9
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">unsigned</span> sender_write_pointer __attribute__( ( aligned ( CACHELINE_SIZE ) ) );</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    10
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">unsigned</span> sender_read_pointer __attribute__( ( aligned ( CACHELINE_SIZE ) ) ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    11
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">unsigned</span> receiver_write_pointer __attribute__( ( aligned ( CACHELINE_SIZE ) ) ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    12
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">unsigned</span> receiver_read_pointer __attribute__ ( ( aligned ( CACHELINE_SIZE ) ) )</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    13
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">unsigned</span> ring_size __attribute__( ( aligned( CACHELINE_SIZE ) ) );</p>

                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    14
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message_t <span class="dk_code_org">*</span>ring __attribute__( ( aligned ( CACHELINE_SIZE ) ) );</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-bottom: 0rem !important; padding-top: 0rem !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    15
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    16
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"><span class="dk_code_blue">public</span> <span class="dk_code_org">:</span></p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    17
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ring ( <span class="dk_code_blue">unsigned</span> size )</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    18
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    19
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ring_size <span class="dk_code_org">=</span> size ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    20
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shared_write_pointer.store ( <span class="dk_code_blue">0</span> ) ;
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    21
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shared_read_pointer.store ( <span class="dk_code_blue">0</span> ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    22
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sender_write_pointer <span class="dk_code_org">=</span> <span class="dk_code_blue">0</span> ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;">
                                    23
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sender_read_pointer <span class="dk_code_org">=</span> <span class="dk_code_blue">0</span> ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    24
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;receiver_write_pointer <span class="dk_code_org">=</span> <span class="dk_code_blue">0</span> ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    25
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;receiver_read_pointer <span class="dk_code_org">=</span> <span class="dk_code_blue">0</span> ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    26
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ring <span class="dk_code_org">=</span> ( message_t <span class="dk_code_org">*</span> ) aligned_alloc ( CACHELINE_SIZE, ring_size <span class="dk_code_org">*</span> sizeof( message_t ) ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    27
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert ( ring ) ;</p>

                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    28
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">for</span> ( <span class="dk_code_blue">unsigned</span> i <span class="dk_code_org">=</span> <span class="dk_code_blue">0</span> ; i <span class="dk_code_org"><</span> ring_size; i <span class="dk_code_org">+=</span> <span class="dk_code_blue">1</span> ) ring [ i ] .sequence .store ( <span class="dk_code_blue">0</span> <span class="dk_code_org">-</span> ring_size ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-bottom: 0rem !important; padding-top: 0rem !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    29
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    30
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    31
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_org">~</span> Ring()</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    32
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    33
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free ( ring ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    34
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ring <span class="dk_code_org">=</span> <span class="dk_code_blue">NULL</span> ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    35
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    36
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    37
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">void </span> send ( message_t <span class="dk_code_org">&</span>msg )</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    38
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    39
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_code_blue">unsigned</span> wp <span class="dk_code_org">=</span> sender_write_pointer;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    40
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_code_blue">while</span> ( ( wp <span class="dk_code_org">-</span> shared_read_pointer.load ( std <span class="dk_code_org">: :</span> memory_order_acquire ) ) <span class="dk_code_org">>=</span> ( ring_size <span class="dk_code_org">-</span><span class="dk_code_blue">1</span> ) ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    41
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memcpy ( <span class="dk_code_org">&</span>ring [ wp % ring_size]  , <span class="dk_code_org">&</span>msg, <span class="dk_code_blue">sizeof</span> ( message_t ) <span class="dk_code_org">-</span> <span class="dk_code_blue">sizeof</span> ( std <span class="dk_code_org">: :</span> atomic_uint32_t ) );</p>

                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    42
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ring [ wp <span class="dk_code_org">%</span> ring_size ] .sequence.store ( wp , std <span class="dk_code_org">: :</span> memory_order_relaxed ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    43
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sender_write_pointer <span class="dk_code_org">=</span> wp <span class="dk_code_org">+=</span> <span class="dk_code_blue">1</span> ;</p>

                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    44
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-bottom: 0rem !important; padding-top: 0rem !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    45
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dk_code_blue">int</span> poll ( ) </p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    46
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    47
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"><span class="dk_code_blue"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unsigned</span> rp <span class="dk_code_org">=</span> receiver_read_pointer;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    48
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; message_t <span class="dk_code_org">*</span>mp <span class="dk_code_org">=</span> <span class="dk_code_org">&</span>ring [ rp <span class="dk_code_org">&</span> ring_size ] ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    49
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_code_blue">if</span> ( mp<span class="dk_code_org">-></span> sequence <span class="dk_code_org">!=</span> rp ) <span class="dk_code_blue">return 0</span> ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    50
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rp <span class="dk_code_org">=</span> rp <span class="dk_code_org">+</span> <span class="dk_code_blue">1</span> ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    51
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_code_blue">if</span> ( ( rp <span class="dk_code_org">&</span> ( ( ring_size <span class="dk_code_org">-</span> <span class="dk_code_blue">1</span> ) <span class="dk_code_org">>></span> <span class="dk_code_blue">1</span> ) ) <span class="dk_code_org">==</span> <span class="dk_code_blue">0</span> ) shared_read_pointer.store ( rp, std <span class="dk_code_org">: :</span> memory_order_release ) ;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    52
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; receiver_read_pointer <span class="dk_code_org">=</span> rp;</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    53
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_code_blue">return</span> (<span class="dk_code_blue">1</span>);</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important; padding-bottom: 0px !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    54
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding-top: 0rem !important;" class="d-flex mv_pre">
                                <div style="border-right: 1px solid #ccc; padding-right: 7px;" class="">
                                    55
                                </div>
                                <div class="">
                                    <div class="mv_code text-break">
                                        <p class="mb-0">};</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p>Rerunning the test program gives dramatically better results.</p>

                    <table align="center" border="1" cellpadding="1" cellspacing="1" style="width:100%" class="dk_new_options_table">
                        <thead>
                            <tr>
                                <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">Number of senders</td>
                                <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">RDTSC Cycles Per Message</td>
                                <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">Receiver misses per message</td>
                                <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">Sender misses per message</td>
                                <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">Messages per second (x10^6)</td>
                                <td style="background: #e2e2e2; text-align: left;">GB/Sec</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 300 !important;">1</td>
                                <td style="font-weight: 300 !important;">48.2</td>
                                <td style="font-weight: 300 !important;">1.23</td>
                                <td style="font-weight: 300 !important;">99</td>
                                <td style="font-weight: 300 !important;">41.5</td>
                                <td style="font-weight: 300 !important;">2.7</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 300 !important;">2</td>
                                <td style="font-weight: 300 !important;">9.8</td>
                                <td style="font-weight: 300 !important;">1.001</td>
                                <td style="font-weight: 300 !important;">1.01</td>
                                <td style="font-weight: 300 !important;">205.0</td>
                                <td style="font-weight: 300 !important;">13.1</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 300 !important;">4</td>
                                <td style="font-weight: 300 !important;">6.8</td>
                                <td style="font-weight: 300 !important;">1.005</td>
                                <td style="font-weight: 300 !important;">1.002</td>
                                <td style="font-weight: 300 !important;">294.1</td>
                                <td style="font-weight: 300 !important;">18.8</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 300 !important;">8</td>
                                <td style="font-weight: 300 !important;">5.3</td>
                                <td style="font-weight: 300 !important;">1.002</td>
                                <td style="font-weight: 300 !important;">1.001</td>
                                <td style="font-weight: 300 !important;">375.5</td>
                                <td style="font-weight: 300 !important;">23.9</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 300 !important;">16</td>
                                <td style="font-weight: 300 !important;">5.9</td>
                                <td style="font-weight: 300 !important;">1.03</td>
                                <td style="font-weight: 300 !important;">1.002</td>
                                <td style="font-weight: 300 !important;">339.1</td>
                                <td style="font-weight: 300 !important;">21.7</td>
                            </tr>
                        </thead>
                    </table>
                    <p>&nbsp;</p>
                    <div class="">
                        <img class="w-100" src="/img/darshit_image/cache-misses2.png" alt="">
                    </div>
                    <p>A single sender can now send 41 million messages per second or 2.7 GB/sec at 64 bytes per message.</p>
                    <p>The performance scales well, and with 8 clients, it reaches 375 million messages per second and about 24 gigabytes/second. In short, we’ve doubled the performance of a single ring buffer and made the design scalable up to nearly the bandwidth limits of the receiving core.</p>
                    </section>

                    <section id="dk_cache_line">
                        <h4>Cache Line Demote</h4>
                        <p>But wait! Remember the new CLDEMOTE instruction?&nbsp; What if we use it to “push” newly written messages from the originator L1 towards lower cache levels?&nbsp; Let's try it!</p>
                        <p>Table using CLDEMOTE to nudge messages on their way.</p>
                        <table align="center" border="1" cellpadding="1" cellspacing="1" style="width:100%" class="dk_new_options_table">
                            <thead>
                                <tr>
                                    <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">Number of senders</td>
                                    <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">RDTSC Cycles Per Message</td>
                                    <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">Receiver misses per message</td>
                                    <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">Sender misses per message</td>
                                    <td style="background: #e2e2e2; text-align: left; border-right: 2px solid #fff !important;">Messages per second (x10^6)</td>
                                    <td style="background: #e2e2e2; text-align: left;">GB/Sec</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;">1</td>
                                    <td style="font-weight: 300 !important;">63.6</td>
                                    <td style="font-weight: 300 !important;">1.33</td>
                                    <td style="font-weight: 300 !important;">0.0001</td>
                                    <td style="font-weight: 300 !important;">31.5</td>
                                    <td style="font-weight: 300 !important;">2.0</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;">2</td>
                                    <td style="font-weight: 300 !important;">38.2</td>
                                    <td style="font-weight: 300 !important;">1.18</td>
                                    <td style="font-weight: 300 !important;">0.0003</td>
                                    <td style="font-weight: 300 !important;">52.3</td>
                                    <td style="font-weight: 300 !important;">3.3</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;">4</td>
                                    <td style="font-weight: 300 !important;">22.2</td>
                                    <td style="font-weight: 300 !important;">1.085</td>
                                    <td style="font-weight: 300 !important;">0.0003</td>
                                    <td style="font-weight: 300 !important;">90.0</td>
                                    <td style="font-weight: 300 !important;">5.8</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;">8</td>
                                    <td style="font-weight: 300 !important;">4.4</td>
                                    <td style="font-weight: 300 !important;">1.002</td>
                                    <td style="font-weight: 300 !important;">0.0001</td>
                                    <td style="font-weight: 300 !important;">452.5</td>
                                    <td style="font-weight: 300 !important;">29.0</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 300 !important;">16</td>
                                    <td style="font-weight: 300 !important;">4.4</td>
                                    <td style="font-weight: 300 !important;">1.02</td>
                                    <td style="font-weight: 300 !important;">0.0001</td>
                                    <td style="font-weight: 300 !important;">457.7</td>
                                    <td style="font-weight: 300 !important;">29.3</td>
                                </tr>
                            </thead>
                        </table>
                        <p>&nbsp;</p>

                        <div class="">
                            <img class="w-100" src="/img/darshit_image/cache-misses3.png" alt="">
                        </div>
                        <p>This is quite interesting!&nbsp; Using CLDEMOTE slows the program a bit for 1 thread, slows it down quite a lot for 2 or 4 threads, and speeds it up by 20% for 8 and 16 threads.&nbsp; With enough threads, the individual clients have enough time to complete their CLDEMOTEs before the server polls, and it is a win.&nbsp; With few threads, sometimes the wait time of the poll operation goes up due to the extra memory system activity.&nbsp; On balance, it seems that CLDEMOTE is a good idea if it is not on the critical performance path.</p>
                    </section>
                    <p class="md-0">&nbsp;</p>

                    <section id="dk_conclusion">
                        <h4 style="font-weight: 300;">Conclusion</h4>
                        <p>Queue designs that minimize memory coherence events can dramatically improve core-to-core message rate and latency. In particular, one can design a queue that, on average, for 64-byte messages, achieves just over 1 cache miss per message at each sender and receiver.</p>
                        <p>Actively managing the cache level and data hierarchy can additionally aid with significant performance improvements in heavily threaded applications. Stay tuned for more</p>
                    </section>
                    <p class="md-0">&nbsp;</p>

                    <section id="dk_download_tool">
                        <h4 style="font-weight: 300;">Download the Toolkits</h4>
                        <p>Check out the <a href="" style="color:#467886; text-decoration:underline !important">Intel® oneAPI HPC Toolkit</a> to stay current with the latest developments in compute-intensive distributed and high-performance computing. You can also download individual components like the Intel® MPI Library <a href="" style="color:#467886; text-decoration:underline !important">standalone</a>.</p>
                        <p>Watch this space for more articles and discussions of interesting software architecture and performance topics.</p>
                    </section>
                    <p class="md-0">&nbsp;</p>

                    <section id="dk_references_faster">
                        <h4 style="font-weight: 300;">References</h4>
                        <p>[1] Rahman, J (2023), <em><a href="" style="color:#467886; text-decoration:underline !important">Intel® Xeon® Scalable Processor Core-To-Core Latency</a></em>, SubStack</p>
                        <p>[2] McCalpin, J (2023), <em><a href="" style="color:#467886; text-decoration:underline !important">Bandwidth Limits in the Intel® Xeon® CPU Max Series</a></em>, International Supercomputing 2023 IXPUG Workshop</p>
                        <p>[3] Herlihy, M. et al. (2020), <em>The Art of Multiprocessor Programming 2<sup>nd</sup> ed</em>., Elsevier, ISBN: 9780124159501.</p>
                    </section>
                    <p>&nbsp;</p>
                    <p>&nbsp;</p>
                    <p>&nbsp;</p>
                </div>
            </div>
        </div>
    </section>
      
     <section style="border-top: 1px solid #d7d7d7;" class="container py-5">
        <h4 class="h6">Product and Performance Information</h4>
        <div class="disclaimer" style="font-size: 12px;"><sup>1</sup> Performance varies by use, configuration and other factors. Learn more at <a class="b_special_a1" href="">www.Intel.com/PerformanceIndex</a>.</div>
        </div>
    </section>

    <!-- footer -->
    <div id="footer"></div>

    <!-- script header and footer -->
    <script>
        // navbar include  
        fetch('/y_index/y_navbar.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('navbar').innerHTML = data;
            });
        // footer include 
        fetch('/y_index/y_footer.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('footer').innerHTML = data;
            });
    </script>

    <!-- nav script -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
        if (document.getElementsByClassName('VK_all_sections section') && document.getElementsByClassName('VK_sidebar_dropdown')) {
            const sections = document.querySelectorAll('.VK_all_sections section');
            const navLinks = document.querySelectorAll('.VK_sidebar_dropdown a');
            const detailsElements = document.querySelectorAll('.VK_sidebar_dropdown details');

            function removeActiveClass() {
                navLinks.forEach(link => link.classList.remove('VK_sidebar_active_link'));
                detailsElements.forEach(details => {
                    details.removeAttribute('open');
                    details.setAttribute('close', ''); // Optional: to visually indicate it's closed
                });
            }

            function activateLinkAndDetails(targetId) {
                navLinks.forEach(link => {
                    if (link.getAttribute('href') === `#${targetId}`) {
                        link.classList.add('VK_sidebar_active_link');
                        let parentDetails = link.closest('details');

                        // Open all ancestor details elements
                        while (parentDetails) {
                            parentDetails.setAttribute('open', '');
                            parentDetails.removeAttribute('close'); // Optional: remove the closed indicator
                            parentDetails = parentDetails.parentElement.closest('details');
                        }
                    }
                });
            }

            function onScroll() {
                let currentSection = '';
                sections.forEach(section => {
                    const sectionTop = section.getBoundingClientRect().top;
                    const sectionBottom = section.getBoundingClientRect().bottom;

                    // Check if the section is in view
                    if (sectionTop <= 100 && sectionBottom >= 0) {
                        currentSection = section.getAttribute('id');
                    }
                });

                if (currentSection) {
                    removeActiveClass();
                    activateLinkAndDetails(currentSection);
                } else {
                    removeActiveClass();
                }
            }

            window.addEventListener('scroll', onScroll);
        } else {
            return
        }
    });
    </script>

    <!-- copy script -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".mv_copy_icon").forEach((icon) => {
                icon.addEventListener("click", async function () {
                    try {
                        const toolbar = this.closest(".mv_code_toolbar");
                        const codeBlock = toolbar.querySelector(".code-content");
                        const codeContent = codeBlock.innerText;
    
                        // Use Clipboard API to copy text
                        await navigator.clipboard.writeText(codeContent);
    
                        // Hide the copy icon and show the "Copied!" message
                        const message = toolbar.querySelector(".mv_copy_message");
                        this.classList.add("hidden"); // Hide the copy icon
                        message.classList.remove("hidden"); // Show the "Copied!" message
    
                        // Hide the message and show the icon again after 2 seconds
                        setTimeout(() => {
                            message.classList.add("hidden");
                            this.classList.remove("hidden");
                        }, 2000); // Adjust delay as needed
    
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                    }
                });
            });
        });
    </script>

</body>

</html>