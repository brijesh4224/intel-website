<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimize LLVM Code Generation for Data Analytics</title>

    <!-- font family -->
    <link href="https://fonts.cdnfonts.com/css/intel-clear" rel="stylesheet">
    <link rel="stylesheet" href="/css/dk_arria_10_FPGA_developer_center.css">
    <link rel="stylesheet"href="/css/dk_developer_edge_iot_5G_industrial_automation_see_all_Intelligent_connection_management_for_automated_handover.css">
    <link rel="stylesheet"href="/css/dk_developer_edge_iot_&_5G_optimize_fine_tuning_and_deployment_of_LLMs_on_an_ai_pc.css">
    <link rel="stylesheet" href="/css/rushita_automotive.css">
    <!-- header footer -->
    <link rel="stylesheet" href='/css/yatri.css'>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" rel="stylesheet">

</head>

<style>
    .dk_color1{
        color: #069 !important;
        font-weight: 700 !important;
    }
    .dk_color2{
        color: #b24501;
    }
    /****** Device Information ******/
        .mv_deploy_nav_tab{
            background-color: #fff;
        }
        .mv_deploy_nav_pills{
            border-bottom: 1px solid #E6E6E6;
            flex-wrap: nowrap !important;
            overflow-x: auto !important;
            width: 100% !important;
        }
        .mv_deploy_nav_link {
            color: #0068b5 !important;
        }
        .mv_deploy_nav_pills .mv_deploy_nav_link{
            background-color: #fff !important;
            text-wrap: nowrap !important;
        }
        .mv_deploy_nav_pills .mv_deploy_nav_link.active{
            border-radius: 0rem !important;
            color: #0068b5 !important;
            border-bottom: 4px solid #00aeef;
            background-color: #F2F2F2 !important;
        }
        .mv_deploy_nav_pills .mv_deploy_nav_link:hover{
            border-radius: 0rem;
            background-color: #F2F2F2 !important;
        }
        .mv_gpu_flex_padd{
            padding: 3rem 0rem;
        }
        .mv_gpu_flex{
            align-content: center;
        }
        .mv_gpu_flex h1{
            font-weight: 350;
        }
        .mv_gpu_flex p{
            margin-bottom: .5rem;
        }
        .mv_gpu_flex p a{
            color: #0068b5;
            border-bottom: 1px dashed #0068b5;
        }
        .mv_gpu_flex p a:hover{
            border-bottom: 1px solid #0068b5;
        }
        .mv_gpu_flex_img img{
            width: 100%;
        }
        .mv_enable_boundless_padd{
            padding: 3rem 0rem;
        }
        .mv_enable_img img{
            width: 100%;
            margin-bottom: 10px;
        }
    @media(max-width:768px){
        .mv_product_table{
            width: 100% !important;
        }
    }
</style>

<body>
    <!-- header -->
    <div id="navbar"></div>

    <!-------------------------------------------------------------------------->
    <section class="m_ai_tdrop" style="border-bottom: 1px solid rgb(226, 221, 221);">
        <div>
            <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                Developers
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item m_dropActive" href="#">Overview</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Topics & Technologies</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Tools</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Resources & Documentation</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Learn</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Community & Events</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Developer Programs</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Get Help</a></li>
            </ul>
        </div>
    
        <div class="m_ai_shlash">/</div>
        <div>
            <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                Tools
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item m_dropActive" href="#">Software Catalog</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">oneAPI</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Open Edge Platform</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">FPGA</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Active Management Technology SDK</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Advisor</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® AI Reference Models</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Collaboration Suite for WebRTC SDK</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Tiber™ AI Cloud</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Distribution for Python*</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Distribution for GDB*</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® DPC++ Compatibility Tool</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Dynamic Application Loader</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Frameworks</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Embree</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Extension for Scikit-learn*</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Fortran Compiler</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Graphics Performance Analyzers</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Homomorphic Encryption Toolkit</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® In-Band Manageability</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Integrated Performance Primitives</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Integrated Simulation Infrastructure with Modeling</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Instruction Set Architecture (ISA) Extensions</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Intelligent Storage Acceleration Library (Intel® ISA-L)</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Modin*</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® MPI Library</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Neural Compressor</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">OpenCL™ Runtime</a></li>   
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Open Image Denoise</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Open Path Guiding Library (Intel® Open PGL)</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Pin</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Platform Analysis Library</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel Tools for OpenCL™ Software</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel Tools for OpenCL™ Applications</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® OpenSWR</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">OpenVINO™ Toolkit</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Open Volume Kernel Library</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Optimization for XGBoost*</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® OSPRay</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® OSPRay for Hydra*</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® OSPRay Studio</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">PyTorch* Optimizations from Intel</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">TensorFlow* Optimizations from Intel</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Rendering Toolkit</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Smart Edge Open</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Software Guard Extensions</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Secure Device Onboard</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Software Development Emulator</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Quantum SDK</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Query Processing Library (Intel® QPL)</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® Video Processing Library</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Intel® VTune™ Profiler</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Resellers</a></li>
            </ul>
        </div>

        <div class="m_ai_shlash">/</div>
        <div>
            <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                oneAPI
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item m_dropActive" href="#">Overview</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Data Parallel C++/SYCL*</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Toolkits</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Tech Articles & How-Tos</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Components</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Code Samples</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Training</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Documentation</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Support</a></li>
            </ul>
        </div>

        <div class="m_ai_shlash">/</div>
        <div>
            <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                Tech Articles & How-Tos
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item m_dropActive" href="#">Library</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">News Updates</a></li>
                <li><a class="dropdown-item m_dropActive" href="#">Webinars</a></li>
            </ul>
        </div>

        <div class="m_ai_shlash">/</div>
        <div class="m_ai_httl">Optimize LLVM Code Generation for Data Analytics</div>
    </section>
    <!-------------------------------------------------------------------------------------------------------->

    <!-- VMware Horizon -->
    <section>
        <div class="mv_vmware_bg_color">
            <div class="container">
                <div class="mv_vmware_padd">
                    <div class="row">
                        <div class="col-md-12 col-sm-12">
                            <div class="mv_vmware_heading">
                                <h3>Optimize LLVM Code Generation for Data Analytics Using Vectorization</h3>
                            </div>
                        </div>
                    </div>
                    <div class="mv_cd_page_marquee_info">
                        <div class="mv_cd_page_marquee_action">
                            <div class="mv_cd_page_marquee_action_padd">
                                <label for="">ID</label>
                                <span>672732</span>
                            </div>
                            <div class="mv_cd_page_marquee_action_padd">
                                <label for="">Updated</label>
                                <span>8/6/2020</span>
                            </div>
                            <div class="mv_cd_page_marquee_action_padd">
                                <label for="">Version</label>
                                <span>Latest</span>
                            </div>
                            <div class="mv_cd_page_marquee_action_padd">
                                <label for=""></label>
                                <span>Public</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section class="container py-5">
        <div class="row">
            <div class="d-flex justify-content-end col-xl-10 py-3 d-md-none">
                <i class="fa-solid fa-print fs-4 px-2 " style="color:#0068B5"></i>
                <i class="fa-regular fa-envelope fs-4 px-2" style="color:#0068B5"></i>
            </div>
            <div class="col-lg-3 col-md-4">
                <!-- nav -->
                <div class="VK_sticky_side_bar VK_side_bar_postion_stickey">
                    <div>
                        <div class="VK_sidebar_dropdown">
                            <details>
                                <summary>
                                    <a href="#dk_The_problem" class="text-decoration-none VK_a">
                                        The Problem and Acceleration via LLVM
                                    </a>
                                </summary>
                                <ul class="list-unstyled ps-3 mb-0">
                                    <li>
                                        <a href="#dk_analyzing" class="text-decoration-none VK_a my-1">
                                            Analyzing the Design
                                        </a>
                                    </li>
                                </ul>
                                <ul class="list-unstyled ps-3 mb-0">
                                    <li>
                                        <a href="#dk_confirming" class="text-decoration-none VK_a my-1">
                                            Confirming Vectorization Opportunity by Profiling
                                        </a>
                                    </li>
                                </ul>
                                <ul class="list-unstyled ps-3 mb-0">
                                    <li>
                                        <a href="#dk_vectorization" class="text-decoration-none VK_a my-1">
                                            Vectorization Approaches
                                        </a>
                                    </li>
                                </ul>
                            </details>
                            <details>
                                <summary>
                                    <a href="#dk_auto_vec" class="text-decoration-none VK_a">
                                        Auto-Vectorization for LLVM Code Generation
                                    </a>
                                </summary>
                                <ul class="list-unstyled ps-3 mb-0">
                                    <li>
                                        <a href="#dk_start_example" class="text-decoration-none VK_a my-1">
                                            Start from a Basic Example 
                                        </a>
                                    </li>
                                </ul>
                                <ul class="list-unstyled ps-3 mb-0">
                                    <li>
                                        <a href="#dk_enable_pass" class="text-decoration-none VK_a my-1">
                                            Enable the Loop Vectorization Optimization Pass
                                        </a>
                                    </li>
                                </ul>
                                <ul class="list-unstyled ps-3 mb-0">
                                    <li>
                                        <a href="#dk_set_engine" class="text-decoration-none VK_a my-1">
                                            Set Up CPU Information for the Engine
                                        </a>
                                    </li>
                                </ul>
                                <ul class="list-unstyled ps-3 mb-0">
                                    <li>
                                        <a href="#dk_set_option" class="text-decoration-none VK_a my-1">
                                            Set the Clang Optimization Option
                                        </a>
                                    </li>
                                </ul>
                            </details>
                            <details>
                                <summary>
                                    <a href="#dk_data_prog" class="text-decoration-none VK_a">
                                            Data-Oriented Programming
                                    </a>
                                </summary>
                                    <ul class="list-unstyled ps-3 mb-0">
                                        <li>
                                            <a href="#dk_example" class="text-decoration-none VK_a my-1">
                                                Example: Simulating a Real Programming Structure
                                            </a>
                                        </li>
                                    </ul>
                                    <ul class="list-unstyled ps-3 mb-0">
                                        <li>
                                            <a href="#dk_performance" class="text-decoration-none VK_a my-1">
                                                Performance Results
                                            </a>
                                        </li>
                                    </ul>
                            </details>
                            <p class="m-0">
                                <a href="#dk_conclusion" class="text-decoration-none VK_a">
                                   Conclusion
                                </a>
                            </p>
                            <p class="m-0">
                                <a href="#dk_other_res" class="text-decoration-none VK_a">
                                    Other Resources
                                </a>
                            </p>
                            <p class="m-0">
                                <a href="#dk_line" class="text-decoration-none VK_a">
                                    -------
                                </a>
                            </p>
                            <p class="m-0">
                                <a href="#dk_you_may" class="text-decoration-none VK_a">
                                    You May Also Like
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
                <!-- thinkcode -->
                <!-- <div class="dk_things_code_main">
                    <div class="dk_things_code">
                        <h2 class="text-left headline-font-one-bold">Loss Prevention Retail Reference Implementation provides:</h2>
                        <div class="dk_high_quality">
                            <ul>
                                <li>High-quality testable ingredients needed to create a solution to prevent thefts at stores.</li>
                                <li>Building blocks needed to enable the use case with solid performance numbers.</li>
                                <li>Hardware requirements to support the workloads and scale the solution.</li>
                            </ul>
                        </div>
                    <div class="dk_get_code">
                        <button class="dk_button">Get Started on GitHub<sup>*</sup></button>
                    </div>
                    </div> 
                </div> -->
            </div>
            <div class="col-lg-9 col-md-8">
                <div class="d-md-flex justify-content-end col-xl-10 py-3 d-none">
                    <i class="fa-solid fa-print fs-4 px-2 " style="color:#0068B5"></i>
                    <i class="fa-regular fa-envelope fs-4 px-2" style="color:#0068B5"></i>
                </div>
                <div class="col-xl-10 VK_all_sections">
                    <div style="padding-bottom: 16px;">
                        <p>&nbsp;</p>
                        <p>&nbsp;</p>
                        <h4>Boost Efficiency for Your Big Data Workloads</h4>
                        <div class="row">
                            <div class="col-6">
                                <p>Bo Jiang, machine learning engineer, and<br> Haifeng Chen, software engineering manager, Intel Corporation<br> <a    class="b_special_a1" href="">@IntelDevTools</a></p>
                            </div>
                            <div class="col-6">
                                <p><strong>Get the Latest on All Things CODE</strong><br> <a class="mv_coman_btn" href="">Sign Up</a></p> 
                            </div>
                        </div>
                        <p>&nbsp;</p>
                        <p>The explosion of big data has spurred tremendous increases in data analytics workloads. Compared to online transaction processing (OLTP), the queries in analytics workloads are usually complex, long-running, and CPU-bound. Code generation is an effective way to accelerate analytical data processing. It allows query-specific information known only at runtime, such as column types and expression operators, to be used in performance-critical functions as if they were available at compile time—yielding more efficient implementations.</p>
                        <p>Low Level Virtual Machine (LLVM) is a collection of open-source compiler libraries and related tools designed to be modular and reusable. The LLVM core libraries provide a modern optimizer, along with code generation support for many popular instruction set architectures. LLVM enables analytics engines to perform just-in-time (JIT) compilation within a running process, taking advantage of the benefits of its powerful optimizer. LLVM runtime code generation is an effective technology used by many data analytics engines (for example, Apache Impala* software, Apache Arrow Gandiva) to improve the execution performance of queries.</p>
                        <p>The performance of the LLVM code generation engine has a key impact on the overall data analytics engine performance. The current implementations don’t fully take advantage of the hardware capabilities of modern CPUs such as vectorization. In this article, we describe our learnings from a real case using Intel® architecture-based vectorization to optimize runtime code generation.</p>
                    </div>
                    <section id="dk_The_problem">
                        <h3 style="font-weight: 350; margin-bottom: 1.5rem;">The Problem and Acceleration via LLVM</h3>
                    </section>
                    <section id="dk_analyzing">
                        <h4>Analyzing the Design</h3>
                        <p>We started with a test code that needed help in optimization. It came from one of the customers of Intel. The code was extracted from data analytics software, and consisted of the query expression evaluation module using LLVM-based runtime code generation.</p>
                        <p style="text-align:center"><img class="w-100" src="/img/darshit_image/optimize-llvm-code-data-analytics-vectorization-fig1.jpg"></p>
                        <p style="text-align:center"><strong>Figure 1. LLVM engine block diagram</strong></p>
                        <p style="text-align:center">&nbsp;</p>
                        <p class="mb-0">The workflow has three stages:</p>
                        <ol> 
                            <li>Create module: The engine creates an LLVM intermedia representation (IR) module using the SQL query from the caller.</li> 
                            <li>Optimize module: It optimizes the created module with LLVM’s optimizers, which are called passes, and provides an optimized module for the JIT engine.</li> 
                            <li>JIT module: The LLVM JIT engine takes data from an inputView and runs the instructions in the optimized module. The resulting data is generated and provided as an outputView.</li> 
                        </ol>
                        <p>In detail, LLVM primarily uses an IR for all parts of code generation. In the module creation stage, the engine uses LLVM’s IRBuilder to programmatically generate IR instructions. For example, for expression evaluation, it uses IRBuilder to generate the code of the loop function prototype, including the IRs to form the loop and the IRs to calculate the expression once inside the loop.</p>
                        <p>There are many duplicated IR codes in the function (for example, the arithmetic operations, the data get and set), so the precompilation technique is used. These common codes are implemented in C++ first (for example, lib.cpp in Figure 1), and then cross-compiled to IR files using Clang. These IR files are called precompiled libs (for example, lib.bc in Figure 1). During code generation, these precompiled libs are loaded and linked with the IRBuilder-generated IR to get a combined IR module. This combined IR module, which consists of all necessary code, is then sent to the LLVM optimizer. After optimization, the IR module is run in the LLVM JIT engine.</p>
                        <p>Although this design increased the SQL execution speed greatly compared to traditional approaches, it still doesn’t fully use the capabilities of modern Intel® CPU architecture. Specifically, the data processing is still row by row. As a result, the vectorization is not enabled.</p>
                        <p>Also, modern Intel CPUs support different vectorization widths using different single instruction, multiple data (SIMD) instructions (for example, Intel® Streaming SIMD Extensions [Intel® SSE], Intel® Advanced Vector Extensions [Intel® AVX], and Intel® Advanced Vector Extensions AVX-512 [Intel® AVX-512]). To take full advantage of the power of Intel CPUs, we need to complete a series of steps.</p>
                        <p>&nbsp;</p>
                    </section> 
                        <section id="dk_confirming">
                            <h4>Confirming Vectorization Opportunity by Profiling</h4>
                            <p class="mb-0">The test code consists of several test cases. A typical test case calculates the expression l_extendedprice*(1-l_discount)*(1+l_tax) over ten million rows of data. The data is organized in columnar data format in memory. For each column, the data structure in memory consists of two buffers:</p>
                            <ul> 
                                <li>char* mData</li> 
                                <li>int8_t* mNull</li> 
                            </ul>
                            <p>The mData buffer is for the data and the mNull buffer is used to indicate whether the corresponding data in mData is null or not.</p>
                            <p class="mb-0">To implement the test case:</p>
                            <ol> 
                                <li>It creates a table schema with several columns and generates the table data with ten million rows.</li> 
                                <li>It generates the function prototype using the expression and optimizes the generated function.</li> 
                                <li>It evaluates (runs) the optimized function with the table data as input and measures the runtime.</li> 
                            </ol>
                            <p>We analyzed the test code with several measures and discovered additional opportunities for optimization. First, we dumped the generated IR, as well as the machine code of the optimized function. We noticed that there were no SIMD (Intel AVX and Intel AVX-512) instructions. Next, we conducted profiling on the baseline program using <a class="b_special_a1" href="">Intel® VTune™ Profiler</a>. Although the hot spot analysis didn’t provide much insight because it can’t analyze the code-generated function, the microarchitecture exploration report showed it’s CPU-bound (Figure 2), making it an area for further optimization. Finally, we analyzed the up limit of the performance. We wrote a minimal test program in C++ to calculate the expression directly in a loop. We compiled it with Clang -O3 and measured the runtime. The result showed that the runtime is about one-seventh of the baseline test code. By checking the disassembly of the program, we see it’s vectorized with SIMD instructions, as expected.</p>
                            <p style="text-align:center"><img class="w-100" src="/img/darshit_image/optimize-llvm-code-data-analytics-vectorization-fig2.jpg" width="680"></p>
                            <p style="text-align:center"><strong>Figure 2. Profiling on the baseline program</strong></p>
                            <p style="text-align:center">&nbsp;</p>
                            <p>The insights from our analysis are consistent. We see vectorization as an approach with high potential for optimizing the test code.</p>
                            <p>&nbsp;</p>
                            <p class="mb-0">&nbsp;</p>
                        </section>

                        <section id="dk_vectorization">
                            <h4>Vectorization Approaches</h4>
                            <p class="mb-0">There are two kinds of auto-vectorizations, explicit and implicit:</p>
                            <ul> 
                                <li>In explicit vectorization, the programmers implement the program using SIMD instructions.</li> 
                                <li>In implicit vectorization, the compiler automatically transforms IRs to SIMD. Implicit vectorization is also known as compiler auto-vectorization.</li> 
                            </ul>
                            <p>We decided to use LLVM loop auto-vectorization because it can be generalized for other expressions, making it more valuable.</p>
                            <p class="mb-0">In the compiler autovectorization approach, there are two factors that impact the LLVM loop autovectorization:</p>
                            <ol> 
                                <li>The LLVM codegen engine should be properly configured for vectorized IR generation (for example, use the proper Clang command-line option, -Ox, to specify the optimization level and use necessary loop-vectorize passes in the module optimization stage to do correct transformation for vectorization).</li> 
                                <li>The source code should be written in designs that are friendly to the loop vectorizer. The relevant techniques are widely discussed in the data-oriented programming paradigm that originated from video game development (for example, proper data layout for efficient usage of the CPU cache and parallelization, address pointer aliasing issue to avoid hindering for Loop-Invariant Code Motion [LICM]).</li> 
                            </ol>
                            <p>In the next sections, we elaborate on how to apply the techniques with sample code following this approach.</p>
                            <p>&nbsp;</p>
                        </section>

                        <section id="dk_auto_vec">
                            <h3 style="font-weight: 350; margin-bottom: 1.5rem;">Auto-Vectorization for LLVM Code Generation</h4>
                        </section>

                        <section id="dk_start_example">
                            <h4>Start from a Basic Example</h4>
                            <p>The sample code shown in this section demonstrates the common LLVM code generation procedure. Based on it, we describe how to properly configure the codegen engine for autovectorization.</p>
                            <p class="mb-0">We created two files: plus.cpp and samplejit.cpp:</p>
                            <ul> 
                                <li>Plus.cpp is used to simulate an expression, which adds ten to the input and stores the sum in the output</li> 
                                <li>Samplejit.cpp is used to simulate the LLVM code generation engine, which loads the prototype module, optimizes it, and finally JIT runs it.</li> 
                            </ul>
                            <p>The code for plus.cpp is:</p>
                            <!-- code toolbar 3 -->
                            <div class="mv_code_toolbar">
                                <div class="mv_toolbar_item mv_copy_icon">
                                    <i class="fa-regular fa-copy"></i>
                                </div>
                                <div class="mv_copy_message text-end hidden">Copied</div>
                                <div class="code-content">
                                    <div style="padding-bottom: 0rem !important" class="d-flex mv_pre">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            1
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"><span class="dk_color1">#define LENARRAY 10240</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            2
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"><span class="dk_color1">typedef char</span> ele_t;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            3
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">ele_t a[LENARRAY], b[LENARRAY];</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            4
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            5
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"><span class="dk_color1">int</span> plus (ele_t aa[], ele_t bb[], <span class="dk_color1">int</span> len)</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            6
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">{</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            7
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp; <span class="dk_color1">for</span> ( <span class="dk_color1">int</span> i <span class="dk_color2">=</span> <span class="dk_color1">0</span> ; i <span><span class="dk_color2"><</span></span> len ; i<span class="dk_color2">++</span> )</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            8
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bb { i ] <span class="dk_color2">=</span> aa [ i ] <span class="dk_color2">+</span> <span class="dk_color1">10</span> ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            9
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp; } </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            10
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp;&nbsp;&nbsp;&nbsp;return 3148;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 1rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            11
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"> <span>}</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p>It simulates the SQL expression b=a+10 logically for 10,240 input rows. It returns a magic number (3,148) to check later.</p>
                            <p>The plus.cpp is compiled into an IR file (plus.ll) using Clang with the following instructions. This step is to simulate the creation of the module.</p>
                            <!-- code toolbar 3 -->
                            <div class="mv_code_toolbar">
                                <div class="mv_toolbar_item mv_copy_icon">
                                    <i class="fa-regular fa-copy"></i>
                                </div>
                                <div class="mv_copy_message text-end hidden">Copied</div>
                                <div class="code-content">
                                    <div style="padding-bottom: 0rem !important" class="d-flex mv_pre">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            1
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">clang -c -emit-llvm -O0 plus.cpp -o plus.bc</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 1rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            2
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">llvm-dis plus.bc - plus.ll</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p>You can easily get vectorized IR code with the proper compile option, -Ox. But in this case, we want to use the LLVM JIT engine to vectorize the loop, so we explicitly specify the optimize level to -O0 (no optimization). From plus.ll, we can see the IR code is not vectorized.</p>
                            <!-- code toolbar 3 -->
                            <div class="mv_code_toolbar">
                                <div class="mv_toolbar_item mv_copy_icon">
                                    <i class="fa-regular fa-copy"></i>
                                </div>
                                <div class="mv_copy_message text-end hidden">Copied</div>
                                <div class="code-content">
                                    <div style="padding-bottom: 0rem !important" class="d-flex mv_pre">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            1
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"><span class="dk_color1">int</span> main{<span class="dk_color1">int</span> argc, <span class="dk_color1">char</span> <span class="dk_color2">**</span>argv)  {</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            2
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; . . .</p>
                                            </div> 
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            3
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; <span style="color: #008200 !important;">// Parse the input LLVM IR file into a module.</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            4
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; . . .</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            5
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; <span style="color: #008200 !important;">// setup the MCJIT execution engine</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            6
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; . . .</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            7
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; <span style="color: #008200 !important;">// Optimize the module</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            8
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; . . .</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            9
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; <span style="color: #008200 !important;">// compile the module to mc</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            10
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; executionEngine <span class="dk_color2">-></span>finalizeObject();</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            11
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            12
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                               <p class="mb-0">&nbsp; &nbsp; <span style="color: #008200 !important;">// run the mc in JIT engine</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            13
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; <span slot="dk_color1">int</span> ( <span class="dk_color2">*</span>func_ptr ) ( ) <span class="dk_color2">=</span> <span class="dk_color1">NULL</span>;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            14
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; func_ptr <span class="dk_color2">=</span> ( int ( <span class="dk_color2">*</span> ) ( ) )executionEngine <span class="dk_color2">-></span>getFunctionAddress ( <span style="color: blue;">" _Z4plusPcS_i "</span> );</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            15
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; <span class="dk_color1">int</span> res <span class="dk_color2">=</span> ( <span class="dk_color2">* </span>func_ptr ) ( );</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            16
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; std <span class="dk_color2">: :</span> cout <span class="dk_color2"><<</span> <span style="color: blue;">"res: "</span> <span class="dk_color2"><<</span> res <span class="dk_color2"><<</span> std <span class="dk_color2">: :</span> end1;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            17
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            18
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; <span class="dk_color1">return 0</span> ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 1rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            19
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"> <span>}</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p>As shown, first the input IR file (that is, plus.ll) is loaded into the engine as a module. Then, the engine optimizes the module. After that, the module is JIT compiled into machine code. The function plus() is run in the JIT engine (_Z4plusPcS_i is the symbol of plus()). The expected value of the variable res is 3,148, which aligns with the return value of plus().</p>
                            <p>Next, we build and run the sample code.</p>
                            <!-- code toolbar 3 -->
                            <div class="mv_code_toolbar">
                                <div class="mv_toolbar_item mv_copy_icon">
                                    <i class="fa-regular fa-copy"></i>
                                </div>
                                <div class="mv_copy_message text-end hidden">Copied</div>
                                <div class="code-content">
                                    <div style="padding-bottom: 0rem !important" class="d-flex mv_pre">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            1
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">echo <span style="color: blue;">"Building llvmtest . . ."</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            2
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">$CPP -o llvmtest samplejit.cpp $CPPFLAGS $LDFLAGS</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            3
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">echo <span style="color: blue;">"Running llvmtest . . ."</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 1rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            4
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">. <span class="dk_color2">/</span> llvmtest plus.ll</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p>There are several key steps to make sure that the LLVM engine is enabled by vectorization.</p>
                            <p>&nbsp;</p>
                        </section>

                        <section id="dk_enable_pass">
                            <h4>Enable the Loop Vectorization Optimization Pass</h4>
                            <p class="mb-0">&nbsp;</p>
                            <p>First, the required loop-optimize passes need to be added to passmanager. The following is a known-good list of passes.</p>

                            <!-- code toolbar 3 -->
                            <div class="mv_code_toolbar">
                                <div class="mv_toolbar_item mv_copy_icon">
                                    <i class="fa-regular fa-copy"></i>
                                </div>
                                <div class="mv_copy_message text-end hidden">Copied</div>
                                <div class="code-content">
                                    <div style="padding-bottom: 0rem !important" class="d-flex mv_pre">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            1
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">std <span class="dk_color2">: :</span> unique_ptr <span class="dk_color2">< </span>llvm <span class="dk_color2">: :</span> legacy <span class="dk_color2">: :</span> PassManager<span class="dk_color2"> ></span> pass_manager( <span class="dk_color1">new</span> llvm <span class="dk_color2">: :</span> legacy <span class="dk_color2">: :</span> PassManager ( ) ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            2
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">pass_manager <span class="dk_color2">-></span> add ( llvm <span class="dk_color2">: :</span> createFunctionInliningPass ( ) ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            3
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">pass_manager <span class="dk_color2">-></span> add ( llvm <span class="dk_color2">: :</span> createLoopRotatePass ( ) ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            4
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">pass_manager <span class="dk_color2">-></span> add ( llvm <span class="dk_color2">: :</span> createLICMPass ( ) );</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            5
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">pass_manager <span class="dk_color2">-></span> add ( llvm <span class="dk_color2">: :</span> createInstructionCombiningPass ( ) ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            6
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">pass_manager <span class="dk_color2">-></span> add ( llvm <span class="dk_color2">: :</span> createPromoteMemoryToRegisterPass ( ) ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            7
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">pass_manager <span class="dk_color2">-></span> add ( llvm <span class="dk_color2">: :</span> createGVNPass ( ) ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            8
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">pass_manager <span class="dk_color2">-></span> add ( llvm <span class="dk_color2">: :</span> createCFGSimplificationPass ( ) ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            9
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">pass_manager <span class="dk_color2">-></span> add ( llvm <span class="dk_color2">: :</span> createLoopVectorizePass ( ) ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            10
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">pass_manager <span class="dk_color2">-></span> add ( llvm <span class="dk_color2">: :</span> createSLPVectorizerPass ( ) ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 1rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            11
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">pass_manager <span class="dk_color2">-></span> add ( llvm <span class="dk_color2">: :</span> createGlobalOptimizerPass ( ) ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p>The order of the passes matters. The FunctionInliningPass should be called before vectorization passes to help generate a function that’s friendlier to the loop-vectorize pass.</p>
                        </section>

                        <section id="dk_set_engine">
                            <p>&nbsp;</p>
                            <h4>Set Up CPU Information for the Engine</h4>
                            <p>Now, we specify the loop vectorize width. The loop vectorize width indicates how much data can be processed by the SIMD instructions at one time. Usually, it should align with the CPU architecture (for example, for Intel SSE, it is 128 bits; for Intel AVX-512, it is 512 bits). It’s recommended to use the EngineBuilder’s setMCPU() method as shown in the following code block because it automatically adapts to different generations of Intel® processors.</p>

                            <!-- code toolbar 3 -->
                            <div class="mv_code_toolbar">
                                <div class="mv_toolbar_item mv_copy_icon">
                                    <i class="fa-regular fa-copy"></i>
                                </div>
                                <div class="mv_copy_message text-end hidden">Copied</div>
                                <div class="code-content">
                                    <div style="padding-bottom: 0rem !important; padding-bottom: 0rem !important;" class="d-flex mv_pre">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            1
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">std <span class="dk_color2">: :</span> string cpuName <span class="dk_color2">=</span> llvm <span class="dk_color2">: :</span> sys <span class="dk_color2">: :</span> getHostCPUName ( ) .str ( ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 1rem !important;" class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            2
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">mEngineBuilder <span class="dk_color2">-></span> setMCPU ( cpuName ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <section id="dk_set_option">
                            <p>&nbsp;</p>
                            <h4>Set the Clang Optimization Option</h4>
                            <p>Compiler auto-vectorization requires explicitly specified compile options. For Clang, the minimal compile option is -O2; for GCC, it is -O3. In this case, we set Clang options to enable optimization flags in the lib building step. For LLVM versions greater than 5.0, the -O1/2/3 option should be specified to avoid the optnone flag being added to the precompiled libs.</p>
                            <p>After applying all the measures above, we build and run samplejit.cpp. We see that the output is res: 3148, which indicates successful JIT compiling and running of the plus() function. We dump the machine code after optimization and see the Intel AVX-512 instructions in place.</p>
                            <p>&nbsp;</p>
                            <p class="mb-0">&nbsp;</p>
                        </section>

                        <section id="dk_data_prog">
                            <h3 style="font-weight: 350;">Data-Oriented Programming</h4>
                            <p>Simply applying the above configurations to the test code couldn’t make it vectorize successfully. That’s because the real-world program isn’t as simple as the example code. Many loops cannot be vectorized due to complicated control flow or unvectorizable types or calls. So, the prototype IR code also needs to be written in a way that’s friendly to the vectorizer. There are many papers and presentations that talk about how to write hardware-friendly code that enables the compiler to generate machine code that best uses CPU features. For this case, we used the direct pointer reference and the pointer noalias techniques. The following example code demonstrates the real-world use cases and how to apply the advanced techniques to make sure that the loops are vectorized by Intel AVX and Intel AVX-512.</p>
                        </section>

                        <section id="dk_example">
                            <p>&nbsp;</p>
                            <h4>Example: Simulating a Real Programming Structure</h4>
                            <p>The following is a sample code for a real-world programming structure.</p>
                            <!-- code toolbar 3 -->
                            <div class="mv_code_toolbar">
                                <div class="mv_toolbar_item mv_copy_icon">
                                    <i class="fa-regular fa-copy"></i>
                                </div>
                                <div class="mv_copy_message text-end hidden">Copied</div>
                                <div class="code-content">
                                    <div style="padding-bottom: 0rem !important" class="d-flex mv_pre">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            1
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"><span class="dk_color1">#define LENARRAY 10240</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            2
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"><span class="dk_color1">typedef unsigned char</span>  nullval_t;</p>
                                            </div> 
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            3
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"><span class="dk_color1">class </span> lvdt</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            4
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">{</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            5
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"><span class="dk_color1">public</span> <span class="dk_color2">:</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            6
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; lvdt ( <span class="dk_color1">unsigned int</span> capacity ) </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            7
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; {</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            8
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mNullVal <span class="dk_color2">=</span> <span class="dk_color1">new</span> nullval_t [ capacity ];</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            9
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="dk_color1">for</span> ( <span class="dk_color1">int</span> i <span class="dk_color2">=</span> <span class="dk_color1">0</span> ; i <span class="dk_color2"><</span> capacity ; i <span class="dk_color2">++</span> )</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            10
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            11
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mNullVal[i] <span class="dk_color2">=</span> rand() <span class="dk_color2">%</span><span class="dk_color1">2</span>;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            12
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                               <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            13
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; }</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            14
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"><span class="dk_color1">public</span> <span class="dk_color2">:</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            15
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; nullval_t <span class="dk_color2">*</span> mNullVal; </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            16
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">};</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            17
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            18
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"><span class="dk_color1">int</span> main( )</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            19
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">{</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            20
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; <span class="dk_color1">int</span> loopcount <span class="dk_color2">=</span> <span class="dk_color1">10240</span>;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            21
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; srand ( time( <span class="dk_color1">0</span> ) ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            22
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; lvdt<span class="dk_color2">*</span>  lvdt1 <span class="dk_color2">=</span> <span class="dk_color1">new</span> lvdt ( LENARRAY ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            23
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; lvdt<span class="dk_color2">*</span>  lvdtout <span class="dk_color2">=</span> <span class="dk_color1">new</span> lvdt ( LENNARAY ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            24
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            25
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #008200;">// the loop</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            26
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; <span class="dk_color1">for</span> ( <span class="dk_color1">int</span> i<span class="dk_color2">=</span><span class="dk_color1">0</span> ; i <span class="dk_color2"><</span> loopcount ; i<span class="dk_color2">++</span> )  {</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            27
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="dk_color2">*</span> ( lvdtout<span class="dk_color2">-></span>mNullVal<span class="dk_color2">+</span>i ) <span class="dk_color2">=</span> <span class="dk_color2">*</span> ( lvdt1<span class="dk_color2">-></span>mNullVal<span class="dk_color2">+</span>i ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            28
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; }</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            29
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; . . .</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            30
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; <span class="dk_color1">return 0</span> ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 1rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            31
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"> <span>}</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p>&nbsp;</p>
                            <p>Build it with this command (note that the loop is not vectorized).</p>
                            <!-- code toolbar 3 -->
                            <div class="mv_code_toolbar">
                                <div class="mv_toolbar_item mv_copy_icon">
                                    <i class="fa-regular fa-copy"></i>
                                </div>
                                <div class="mv_copy_message text-end hidden">Copied</div>
                                <div class="code-content">
                                    <div style="padding-bottom: 0rem !important; padding-bottom: 1rem !important;" class="d-flex mv_pre">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            1
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">clang <span class="dk_color2">/</span>loopvect.cpp <span class="dk_color2">-</span>fno<span class="dk_color2">-</span>use<span class="dk_color2">-</span>cxa<span class="dk_color2">-</span>atexit <span class="dk_color2">-</span>emit<span class="dk_color2">-</span>llvm <span class="dk_color2">-</span>S <span class="dk_color2">-</span>O2 <span class="dk_color2">-</span>mavx512f <span class="dk_color2">-</span>c <span class="dk_color2">-</span>Rpass<span class="dk_color2">=</span>loop<span class="dk_color2">-</span>vectorize <span class="dk_color2">-</span>Rpass<span class="dk_color2">-</span>analysis<span class="dk_color2">=</span>loop-vectorize</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p>&nbsp;</p>
                            <p>The debug output shows “loop not vectorized: cannot identify array bounds.” This means the optimizer can’t verify that the pointers in the loop are not aliasing.</p>
                            <p>To understand pointer aliasing, let’s look at simpler code. To prove it's safe to vectorize the following loop, array A must show that it’s not an alias of array B. However, the bounds of array A can’t be identified.</p>
                            <!-- code toolbar 3 -->
                            <div class="mv_code_toolbar">
                                <div class="mv_toolbar_item mv_copy_icon">
                                    <i class="fa-regular fa-copy"></i>
                                </div>
                                <div class="mv_copy_message text-end hidden">Copied</div>
                                <div class="code-content">
                                    <div style="padding-bottom: 0rem !important" class="d-flex mv_pre">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            1
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"><span class="dk_color1">void</span> test ( <span class="dk_color1">int</span> <span class="dk_color2">*</span>A, <span class="dk_color1">int</span> <span class="dk_color2">*</span>B <span class="dk_color1">int</span> Length ) {</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            2
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; <span class="dk_color1">for</span> ( <span class="dk_color1">int</span> i <span class="dk_color2">=</span><span class="dk_color1">0</span>; i <span class="dk_color2"><</span> Length; i<span class="dk_color2">++</span> )</p>
                                            </div> 
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            3
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; A [ B [ i ] ] <span class="dk_color2">++</span> ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            4
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            5
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            6
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">clang <span class="dk_color2">-</span>O3 <span class="dk_color2">-</span>Rpass<span class="dk_color2">-</span>analysis<span class="dk_color2">=</span> loop<span class="dk_color2">-</span>vectorize <span class="dk_color2">-</span>S test.c <span class="dk_color2">-</span>o <span class="dk_color2">/</span>dev<span class="dk_color2">/</span>null</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            7
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            8
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">test.c <span class="dk_color2">:</span> <span class="dk_color1">3</span> <span class="dk_color2">:</span> <span class="dk_color1">5</span> <span class="dk_color2">:</span> remark ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            9
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; loop  <span class="dk_color2">not</span> vectorized <span class="dk_color2">:</span> cannot identify array bounds</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 1rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            10
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="dk_color1">for</span> ( <span class="dk_color1">int</span> i <span class="dk_color2">=</span><span class="dk_color1">0</span>; i <span class="dk_color2"><</span> Length; i<span class="dk_color2">++</span> )</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p>&nbsp;</p>
                            <p>There are techniques to address the pointer aliasing problem. If it’s certain that A and B point to nonoverlapping memory ranges, we can inform the compiler by explicitly using the #pragma Clang loop directive prior to the loop, such as:</p>
                            <!-- code toolbar 3 -->
                            <div class="mv_code_toolbar">
                                <div class="mv_toolbar_item mv_copy_icon">
                                    <i class="fa-regular fa-copy"></i>
                                </div>
                                <div class="mv_copy_message text-end hidden">Copied</div>
                                <div class="code-content">
                                    <div style="padding-bottom: 0rem !important; padding-bottom: 1rem !important;" class="d-flex mv_pre">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            1
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"><span class="dk_color1">#programa clang loop vectorize(enable)</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p>&nbsp;</p>
                            <p>Another method that has the same effect is to add the restrict qualifier to the function parameters in the C/C++ code:</p>
                            <!-- code toolbar 3 -->
                            <div class="mv_code_toolbar">
                                <div class="mv_toolbar_item mv_copy_icon">
                                    <i class="fa-regular fa-copy"></i>
                                </div>
                                <div class="mv_copy_message text-end hidden">Copied</div>
                                <div class="code-content">
                                    <div style="padding-bottom: 0rem !important; padding-bottom: 1rem !important;" class="d-flex mv_pre">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            1
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"><span class="dk_color1">void</span> test ( <span class="dk_color1">int</span><span class="dk_color2">*</span> restrict A, <span class="dk_color1">int</span class="dk_color2">*<span></span> restrict B, <span class="dk_color1">int</span> Length )</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p>Now we have a question. Since the prototype module in the code generation scenario is written in IR using IRBuilder, neither the pragma nor the restrict keyword is applicable. How do we make it work in LLVM IR? The answer is that in LLVM, the noalias attribute is equivalent to the C restrict qualifier in function parameters.</p>
                            <p>In the test code, the situation is a bit complex because it used indirect pointers in the loop. That makes the LLVM’s optimizer harder to vectorize the loop. To address this, get the direct pointers to the buffers outside the loop and use them in the loop. The idea is shown in the following real-world example code.</p>
                            <!-- code toolbar 3 -->
                            <div class="mv_code_toolbar">
                                <div class="mv_toolbar_item mv_copy_icon">
                                    <i class="fa-regular fa-copy"></i>
                                </div>
                                <div class="mv_copy_message text-end hidden">Copied</div>
                                <div class="code-content">
                                    <div style="padding-bottom: 0rem !important" class="d-flex mv_pre">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            1
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0"><span class="dk_color1">int</span> main( )</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            2
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">{</p>
                                            </div> 
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            3
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; <span class="dk_color1">int</span> loopcount <span class="dk_color2">=</span> <span class="dk_color1">10240</span>;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            4
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; srand ( time ( <span class="dk_color1">0</span> ) <span class="dk_color1">0</span> ;</p>
                                            </div> 
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            5
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; lvdt<span class="dk_color2">*</span>  lvdt1 <span class="dk_color2">-</span>  <span class="dk_color1">new</span> lvdt( LENARRAY ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            6
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; lvdt<span class="dk_color2">*</span>  lvdtout <span class="dk_color2">-</span>  <span class="dk_color1">new</span> lvdt( LENARRAY ) ;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            7
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; nullval_t <span class="dk_color2">*</span>p1 <span class="dk_color2">=</span> lvdt1<span class="dk_color2">-></span>mNullVal;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            8
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; nullval_t <span class="dk_color2">*</span> pout <span class="dk_color2">=</span> lvdtouts <span class="dk_color2">-></span> mNullval;</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            9
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #008200;">// updated loop which can be vectorized</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            10
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; <span class="dk_color1">for</span> ( <span class="dk_color1">int</span> i <span class="dk_color2">=</span> <span class="dk_color1">0</span> ; i <span class="dk_color2"><</span>loopcount ; i<span class="dk_color2">++</span> ) {</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            11
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="dk_color2">*</span> ( pout <span class="dk_color2">+</span> i ) <span class="dk_color2">=</span> <span class="dk_color2">*</span> ( p1 <span class="dk_color2">+</span> i );</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            12
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            13
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; . . .</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 0rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            14
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="dk_color1">return 0</span>; </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 0rem !important; padding-bottom: 1rem !important;"
                                        class="d-flex mv_pre pb-0">
                                        <div style="border-right: 1px solid #ccc" class="pe-3">
                                            15
                                        </div>
                                        <div class="">
                                            <div class="mv_code text-break">
                                                <p class="mb-0">}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <section id="dk_performance">
                            <p class="mb-0">&nbsp;</p>
                            <h4>Performance Results</h4>
                            <p>After applying these techniques to the baseline test code, we successfully generated vectorized expression evaluation functions for all the test cases. We measured the performance improvement of the test cases on a server (Figure 3).</p>
                            <p style="text-align:center"><img class="w-100" src="/img/darshit_image/optimize-llvm-code-data-analytics-vectorization-fig3.jpg"></p>
                            <p style="text-align:center"><strong>Figure 3. Performance improvement of the test cases</strong></p>
                            <p style="text-align:center">&nbsp;</p>
                            <p>Server configuration: Intel® Xeon® Gold 6252 processor at 2.10G Hz, 512 GB memory, Fedora 29 operating system (Server Edition), LLVM: Clang version 7.0.1.</p>
                            <p>For the expression l_extendedprice * (1 – l_discount) * (1 + l_tax), the result is shown, and the vectorization acceleration is at most 7.5x with Intel AVX-512 instructions. The data types are double-precision float point. We controlled the vectorize width to get the runtime for Intel SSE, Intel AVX2, and Intel AVX-512, respectively. For the test cases with other simpler expression (for example, single operator), the improvement is even higher (greater than 10x).</p>
                            <p>Running the microarchitecture exploration again, we see the core-bound percentage is reduced and memory bound is appearing. This is reasonable, since Intel AVX-512 instructions increase the demand for data 8x over the original scalar version (Figure 4).</p>
                            <p style="text-align:center"><img class="w-100" alt="" src="/img/darshit_image/optimize-llvm-code-data-analytics-vectorization-fig4.jpg" width="633"></p>
                            <p style="text-align:center"><strong>Figure 4. AVX-512 instructions increase the demand for data 8x over the original scalar.</strong></p>
                            <p>&nbsp;</p>
                            <p>&nbsp;</p>
                        </section>

                        <section id="dk_conclusion">
                            <h3 style="font-weight: 350;">Conclusion</h4>
                            <p>In this article, we introduced the theory of LLVM runtime code generation and its implementation in data analytics engines. We also described our work analyzing and autovectorizing the codegen in a practical case. The results demonstrate significant performance improvement using the Intel AVX-512 instructions on test code provided by a customer of Intel.</p>
                            <p>LLVM code generation optimization is a large area for query acceleration in data analytics. The techniques we introduced in this article are only a small portion. There are also other methods, such as whole-stage code generation and columnar data layout, that are worth further investigation.</p>
                            <p>We hope our learnings from this case can be helpful for similar optimizations in the data analytics world.</p>
                            <p style="text-align:center">&nbsp;</p>
                        </section>

                        <section id="dk_other_res">
                            <h3 style="font-weight: 350;">Other Resources</h3>
                            <p><a class="b_special_a1" href="">Intel® VTune™ Profiler</a> helps you locate performance bottlenecks faster. Advanced sampling and profiling techniques quickly analyze your code, isolate issues, and deliver insights for optimizing performance on modern processors. Download it for free or get it as part of the <a class="b_special_a1" href="">Intel® Parallel Studio XE</a> tool suite.</p>
                            <p>&nbsp;</p>
                            <h2 style="opacity: 0.5;">______<a class="inpage-nav-anchor" id="inpage-nav-12"></a></h2>
                        </section>

                        <section id="dk_you_may">
                            <p>&nbsp;</p>
                            <h3 style="font-weight: 350;">You May Also Like</h3>
                            <div class="mv_deploy_nav_tab">
                                <ul class="nav nav-pills mv_deploy_nav_pills pt-3" id="pills-tab" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active mv_deploy_nav_link" id="pills-home-tab" data-bs-toggle="pill"
                                            data-bs-target="#pills-home" type="button" role="tab" aria-controls="pills-home"
                                            aria-selected="true">Related Webinars</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link mv_deploy_nav_link" id="pills-profile-tab" data-bs-toggle="pill"
                                            data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile"
                                            aria-selected="false">Get the Software</button>
                                    </li>
                                </ul>
                                <div class="tab-content" id="pills-tabContent">
                                        <!-- 1. Device Information -->
                                        <div class="tab-pane fade show active" id="pills-home" role="tabpanel"
                                            aria-labelledby="pills-home-tab" tabindex="0">
                                            <div class="mv_coman_padd" style=" border-bottom: 1px solid #ddd; display: flex; padding-bottom: 1rem;">
                                                <div class="">
                                                    <p class="mb-0">Co-Design for Accelerating Analytics with Today’s CPU &amp; Tomorrow’s<br> Heterogeneous Compute Landscape<br></p>
                                                    <a class="b_special_a1" href="">Watch</a>
                                                </div>
                                                <div class="">
                                                    
                                                </div>
                                            </div>
                                            <!-- User Guides -->
                                            
                                        </div>
                                        <!-- 2. Interface Protocol -->
                                        <div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab"
                                            tabindex="0">
                                            <div class="mv_coman_padd" style=" border-bottom: 1px solid #ddd; display: flex; padding-bottom: 1rem;">
                                                <div class="">
                                                    <p><strong><a class="b_special_a1" href="">Intel® VTune™ Profiler</a></strong><br> Find and optimize performance bottlenecks across CPU, GPU,<br> and FPGA systems. Part of the Intel® oneAPI Base Toolkit.<br> <br> <a class="mv_coman_btn" href="">Download the Base Toolkit</a><br> <br> <a class="b_special_a1 " href="">See All Tools</a></p>
                                                </div>
                                                <div class="">
                                                    
                                                </div>
                                            </div>
                                            <!-- User Guides -->
                                        </div>
                                </div>
                            </div>
                        </section>
                </div>
            </div>
        </div>
    </section>

    <section style="border-top: 1px solid #d7d7d7;" class="container py-5">
        <h4 class="h6">Product and Performance Information</h4>
        <div class="disclaimer" style="font-size: 12px;"><sup>1</sup> Performance varies by use, configuration and other
            factors. Learn more at <a class="b_special_a1" href="">www.Intel.com/PerformanceIndex.</a></div>
        </div>
    </section>

    <!-- footer -->
    <div id="footer"></div>

    <!-- nav script -->
    <script>
        // navbar include  
        fetch('/y_index/y_navbar.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('navbar').innerHTML = data;
            });
        // footer include 
        fetch('/y_index/y_footer.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('footer').innerHTML = data;
            });
    </script>
    <!-- nav script -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementsByClassName('VK_all_sections section') && document.getElementsByClassName('VK_sidebar_dropdown')) {
                const sections = document.querySelectorAll('.VK_all_sections section');
                const navLinks = document.querySelectorAll('.VK_sidebar_dropdown a');
                const detailsElements = document.querySelectorAll('.VK_sidebar_dropdown details');

                function removeActiveClass() {
                    navLinks.forEach(link => link.classList.remove('VK_sidebar_active_link'));
                    detailsElements.forEach(details => {
                        details.removeAttribute('open');
                        details.setAttribute('close', ''); // Optional: to visually indicate it's closed
                    });
                }

                function activateLinkAndDetails(targetId) {
                    navLinks.forEach(link => {
                        if (link.getAttribute('href') === `#${targetId}`) {
                            link.classList.add('VK_sidebar_active_link');
                            let parentDetails = link.closest('details');

                            // Open all ancestor details elements
                            while (parentDetails) {
                                parentDetails.setAttribute('open', '');
                                parentDetails.removeAttribute('close'); // Optional: remove the closed indicator
                                parentDetails = parentDetails.parentElement.closest('details');
                            }
                        }
                    });
                }

                function onScroll() {
                    let currentSection = '';
                    sections.forEach(section => {
                        const sectionTop = section.getBoundingClientRect().top;
                        const sectionBottom = section.getBoundingClientRect().bottom;

                        // Check if the section is in view
                        if (sectionTop <= 100 && sectionBottom >= 0) {
                            currentSection = section.getAttribute('id');
                        }
                    });

                    if (currentSection) {
                        removeActiveClass();
                        activateLinkAndDetails(currentSection);
                    } else {
                        removeActiveClass();
                    }
                }

                window.addEventListener('scroll', onScroll);
            } else {
                return
            }
        });
    </script>

    <!-- copy script -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".mv_copy_icon").forEach((icon) => {
                icon.addEventListener("click", async function () {
                    try {
                        const toolbar = this.closest(".mv_code_toolbar");
                        const codeBlock = toolbar.querySelector(".code-content");
                        const codeContent = codeBlock.innerText;

                        // Use Clipboard API to copy text
                        await navigator.clipboard.writeText(codeContent);

                        // Hide the copy icon and show the "Copied!" message
                        const message = toolbar.querySelector(".mv_copy_message");
                        this.classList.add("hidden"); // Hide the copy icon
                        message.classList.remove("hidden"); // Show the "Copied!" message

                        // Hide the message and show the icon again after 2 seconds
                        setTimeout(() => {
                            message.classList.add("hidden");
                            this.classList.remove("hidden");
                        }, 2000); // Adjust delay as needed

                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                    }
                });
            });
        });
    </script>

</body>

</html>



